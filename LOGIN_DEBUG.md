# üîß Diagn√≥stico y Soluci√≥n - Error de Login Frontend

## üîç Problema Detectado

El backend funciona correctamente (login con curl exitoso), pero el frontend muestra error.

### Posibles Causas

1. **CORS bloqueado**: El navegador bloquea la petici√≥n por pol√≠tica CORS
2. **URL incorrecta**: La URL del API no est√° configurada correctamente
3. **userId null**: El backend retorna `"userId": null` que puede causar problemas

---

## ‚úÖ Soluciones

### 1. Verificar Consola del Navegador

Abre las DevTools del navegador (F12) y ve a la pesta√±a "Console" y "Network":

```
F12 ‚Üí Console
F12 ‚Üí Network ‚Üí Filtrar por "login"
```

**Busca:**
- ‚ùå `CORS error` ‚Üí Ver soluci√≥n CORS abajo
- ‚ùå `Failed to fetch` ‚Üí Ver soluci√≥n de red abajo
- ‚ùå `404 Not Found` ‚Üí Verificar URL del API
- ‚ùå `401 Unauthorized` ‚Üí Credenciales incorrectas

### 2. Soluci√≥n CORS (M√°s Probable)

El backend Spring Boot debe tener configuraci√≥n CORS correcta:

**Archivo:** `backend/src/main/java/styp/com/cenate/config/WebConfig.java`

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOrigins(
                    "http://localhost:3000",
                    "http://localhost:5173",
                    "http://localhost",
                    "http://10.0.89.239:5173"
                )
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```

### 3. Verificar SecurityConfig

**Archivo:** `backend/src/main/java/styp/com/cenate/security/SecurityConfig.java`

Aseg√∫rate de que el endpoint `/api/auth/login` est√© permitido sin autenticaci√≥n:

```java
http.authorizeHttpRequests(auth -> auth
    .requestMatchers("/api/auth/**").permitAll()
    .requestMatchers("/api/public/**").permitAll()
    // ... resto de configuraci√≥n
);
```

### 4. Corregir userId null en Backend

**Problema:** La respuesta del login tiene `"userId": null`

**Soluci√≥n:** Actualizar el m√©todo de login para incluir el userId

**Archivo:** `AuthController.java` o `AuthService.java`

```java
// En el m√©todo de login, aseg√∫rate de incluir el userId
LoginResponse response = LoginResponse.builder()
    .token(jwt)
    .username(userDetails.getUsername())
    .nombreCompleto(usuario.getNombreCompleto())
    .userId(usuario.getIdUser()) // ‚Üê AGREGAR ESTA L√çNEA
    .rolPrincipal(rolPrincipal)
    .roles(roles)
    .permisos(permisos)
    .build();
```

---

## üß™ Pruebas de Diagn√≥stico

### Test 1: Verificar que el backend responde

```bash
curl -X POST "http://localhost:8080/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"scantor","password":"admin123"}'
```

**Esperado:** Status 200 + JSON con token

### Test 2: Verificar CORS desde navegador

Abre la consola del navegador (F12) y ejecuta:

```javascript
fetch('http://localhost:8080/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({username:'scantor',password:'admin123'})
})
.then(r => r.json())
.then(d => console.log('‚úÖ Respuesta:', d))
.catch(e => console.error('‚ùå Error:', e))
```

### Test 3: Verificar .env del frontend

```bash
cat frontend/.env.development
```

**Debe contener:**
```
REACT_APP_API_URL=http://localhost:8080/api
```

### Test 4: Verificar que el frontend use la URL correcta

```bash
grep -r "API_BASE" frontend/src/config/
```

---

## üöÄ Soluci√≥n R√°pida - Reiniciar Todo

Si nada de lo anterior funciona:

```bash
# 1. Detener todo
docker-compose down
pkill -f spring-boot
pkill -f react

# 2. Limpiar cach√©
cd frontend
rm -rf node_modules/.cache
rm -rf build

# 3. Reiniciar backend
cd ../backend
./mvnw clean
./mvnw spring-boot:run

# En otra terminal:
# 4. Reiniciar frontend
cd frontend
npm start
```

---

## üìã Checklist de Verificaci√≥n

Marca cada punto que verifiques:

- [ ] Backend corriendo en http://localhost:8080
- [ ] Frontend corriendo en http://localhost:3000
- [ ] Consola del navegador sin errores CORS
- [ ] Consola del navegador sin errores 404
- [ ] Network tab muestra petici√≥n a `/api/auth/login`
- [ ] Respuesta del backend incluye `token` y `userId`
- [ ] CORS configurado en backend
- [ ] SecurityConfig permite `/api/auth/**`
- [ ] `.env` tiene `REACT_APP_API_URL` correcto

---

## üêõ Errores Comunes y Soluciones

### Error: "CORS policy: No 'Access-Control-Allow-Origin'"

**Soluci√≥n:**
```java
// En SecurityConfig.java
@Bean
public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    configuration.setAllowedOrigins(Arrays.asList("http://localhost:3000"));
    configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
    configuration.setAllowedHeaders(Arrays.asList("*"));
    configuration.setAllowCredentials(true);
    
    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    source.registerCorsConfiguration("/api/**", configuration);
    return source;
}

// Y en el m√©todo SecurityFilterChain:
http.cors(cors -> cors.configurationSource(corsConfigurationSource()))
```

### Error: "Failed to fetch"

**Causa:** Backend no est√° corriendo o URL incorrecta

**Soluci√≥n:**
```bash
# Verificar que el backend est√© activo
curl http://localhost:8080/actuator/health

# Si no responde, reiniciar:
cd backend
./mvnw spring-boot:run
```

### Error: "Network Error"

**Causa:** Firewall o proxy bloqueando la conexi√≥n

**Soluci√≥n:**
```bash
# Verificar firewall
sudo ufw status  # Linux
# O en macOS:
/usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate
```

---

## üìû Informaci√≥n de Debug

Para obtener m√°s informaci√≥n, activa el modo debug:

**Backend (application.properties):**
```properties
logging.level.org.springframework.web=DEBUG
logging.level.org.springframework.security=DEBUG
```

**Frontend (Login.jsx):**
Agregar m√°s logs:
```javascript
const handleLogin = async (e) => {
    e.preventDefault();
    console.log('üîê Intentando login con:', { username, password: '***' });
    
    try {
        const data = await loginUser(username, password);
        console.log('‚úÖ Login exitoso:', data);
        // ...
    } catch (err) {
        console.error('‚ùå Error completo:', err);
        console.error('‚ùå Stack:', err.stack);
        // ...
    }
};
```

---

## üéØ Soluci√≥n Final Recomendada

**Ejecuta este comando para verificar todo:**

```bash
#!/bin/bash

echo "üîç Diagn√≥stico del sistema de login..."
echo ""

# 1. Verificar backend
echo "1Ô∏è‚É£ Verificando backend..."
curl -s http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"scantor","password":"admin123"}' | jq -r '.token' > /dev/null

if [ $? -eq 0 ]; then
    echo "   ‚úÖ Backend responde correctamente"
else
    echo "   ‚ùå Backend no responde - Iniciar con: ./mvnw spring-boot:run"
fi

# 2. Verificar frontend
echo "2Ô∏è‚É£ Verificando frontend..."
if curl -s http://localhost:3000 > /dev/null; then
    echo "   ‚úÖ Frontend est√° activo"
else
    echo "   ‚ùå Frontend no activo - Iniciar con: npm start"
fi

# 3. Verificar .env.development
echo "3Ô∏è‚É£ Verificando configuraci√≥n..."
if grep -q "REACT_APP_API_URL" frontend/.env.development 2>/dev/null; then
    echo "   ‚úÖ .env configurado"
    cat frontend/.env.development | grep API_URL
else
    echo "   ‚ùå .env no encontrado o incorrecto"
fi

echo ""
echo "Abre el navegador en http://localhost:3000 y revisa la consola (F12)"
```

Guarda este script como `check-login.sh` y ejec√∫talo:

```bash
chmod +x check-login.sh
./check-login.sh
```
