# üöÄ GU√çA DE IMPLEMENTACI√ìN - Sistema con C√≥digos de Usuario

## üìã Resumen de Cambios

Hemos actualizado tu sistema para usar **c√≥digos de usuario** en lugar de DNI:

### ‚úÖ Lo que ya funciona:
- Backend usa `name_user` (campo de texto) ‚úÖ
- Base de datos acepta c√≥digos alfanum√©ricos ‚úÖ
- API REST ya est√° lista ‚úÖ

### üîÑ Lo que necesitas actualizar:
- Frontend para pedir "C√≥digo de Usuario" en lugar de "DNI"
- Crear usuarios con c√≥digos en la base de datos

---

## PASO 1: Actualizar Base de Datos

### 1.1 Conectar a PostgreSQL

```bash
psql -U postgres -d maestro_cenate
```

### 1.2 Ejecutar Script de Usuarios

```bash
# Desde terminal
psql -U postgres -d maestro_cenate -f backend/sql/04_crear_usuarios_con_codigos.sql

# O desde psql
\i /ruta/completa/backend/sql/04_crear_usuarios_con_codigos.sql
```

### 1.3 Verificar Usuarios Creados

```sql
SELECT 
    u.name_user as "C√≥digo",
    STRING_AGG(r.desc_rol, ', ') as "Roles",
    u.stat_user as "Estado"
FROM dim_usuarios u
LEFT JOIN usuarios_roles ur ON u.id_user = ur.id_user
LEFT JOIN dim_roles r ON ur.id_rol = r.id_rol
GROUP BY u.id_user, u.name_user, u.stat_user
ORDER BY u.id_user;
```

**Resultado esperado:**
```
   C√≥digo    |    Roles     | Estado 
-------------|--------------|--------
 superadmin  | SUPERADMIN   | ACTIVO
 ADMIN001    | ADMIN        | ACTIVO
 MED001      | ESPECIALISTA | ACTIVO
 RAD001      | RADIOLOGO    | ACTIVO
 USR001      | USUARIO      | ACTIVO
```

---

## PASO 2: Actualizar Frontend

### 2.1 Ubicaci√≥n de Archivos

Los archivos actualizados est√°n en:
```
frontend/ejemplos/
‚îú‚îÄ‚îÄ LoginPanel.jsx (ACTUALIZADO)
‚îî‚îÄ‚îÄ LoginPanel.css (ACTUALIZADO)
```

### 2.2 Copiar Archivos Actualizados

#### Si usas Vite:
```bash
cd cenate-frontend
cp ../frontend/ejemplos/LoginPanel.jsx src/
cp ../frontend/ejemplos/LoginPanel.css src/
```

#### Si usas Create React App:
```bash
cd cenate-frontend
cp ../frontend/ejemplos/LoginPanel.jsx src/
cp ../frontend/ejemplos/LoginPanel.css src/
```

### 2.3 Verificar que App.jsx est√© configurado

Tu `App.jsx` debe tener:
```jsx
import LoginPanel from './LoginPanel';

function App() {
  return (
    <BrowserRouter>
      <AuthProvider>
        <Routes>
          <Route path="/login" element={<LoginPanel />} />
          {/* ... otras rutas */}
        </Routes>
      </AuthProvider>
    </BrowserRouter>
  );
}
```

---

## PASO 3: Probar el Sistema

### 3.1 Iniciar Backend

```bash
cd backend
./mvnw spring-boot:run
```

**Verificar que est√° corriendo:**
```bash
curl http://localhost:8080/api/auth/health
# Debe responder: {"status":"OK","service":"Authentication Service"}
```

### 3.2 Iniciar Frontend

```bash
cd frontend
npm run dev    # Vite
# o
npm start      # Create React App
```

### 3.3 Abrir en Navegador

- Vite: `http://localhost:5173`
- CRA: `http://localhost:3000`

### 3.4 Probar Login

Usa cualquiera de estos usuarios:

| C√≥digo Usuario | Contrase√±a | Rol |
|----------------|------------|-----|
| `superadmin` | `SuperAdmin2024!` | SUPERADMIN |
| `ADMIN001` | `SuperAdmin2024!` | ADMIN |
| `MED001` | `SuperAdmin2024!` | ESPECIALISTA |
| `RAD001` | `SuperAdmin2024!` | RADIOLOGO |
| `USR001` | `SuperAdmin2024!` | USUARIO |

---

## PASO 4: Crear Usuarios Personalizados

### 4.1 Usando el Panel de Administraci√≥n (Recomendado)

1. Login como `superadmin`
2. Ir a "Administraci√≥n" ‚Üí "Usuarios"
3. Click en "+ Crear Usuario"
4. Ingresar datos:
   - **Usuario:** `DR_PEREZ` (o el c√≥digo que prefieras)
   - **Contrase√±a:** `Password2024!`
   - **Roles:** Seleccionar rol apropiado
   - **Estado:** ACTIVO
5. Click en "Crear Usuario"

### 4.2 Usando SQL (Avanzado)

```sql
DO $$
DECLARE
    v_id_rol INTEGER;
BEGIN
    -- Seleccionar el rol (SUPERADMIN, ADMIN, ESPECIALISTA, RADIOLOGO, USUARIO)
    SELECT id_rol INTO v_id_rol 
    FROM dim_roles 
    WHERE desc_rol = 'ESPECIALISTA';
    
    -- Crear el usuario
    INSERT INTO dim_usuarios (
        name_user, 
        pass_user, 
        stat_user, 
        create_at, 
        update_at, 
        password_changed_at, 
        failed_attempts
    ) VALUES (
        'DR_GARCIA',  -- Tu c√≥digo de usuario
        '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhCy', -- SuperAdmin2024!
        'ACTIVO',
        CURRENT_TIMESTAMP, 
        CURRENT_TIMESTAMP, 
        CURRENT_TIMESTAMP, 
        0
    );
    
    -- Asignar rol
    INSERT INTO usuarios_roles (id_user, id_rol)
    SELECT id_user, v_id_rol 
    FROM dim_usuarios 
    WHERE name_user = 'DR_GARCIA';
    
    RAISE NOTICE 'Usuario DR_GARCIA creado exitosamente';
END $$;
```

---

## PASO 5: Convenciones de C√≥digos (Sugerencias)

### Ejemplos de C√≥digos por √Årea:

| √Årea | Formato | Ejemplos |
|------|---------|----------|
| **Administraci√≥n** | `ADM###` | `ADM001`, `ADM002` |
| **M√©dicos** | `MED###` o `DR_NOMBRE` | `MED001`, `DR_PEREZ` |
| **Radiolog√≠a** | `RAD###` | `RAD001`, `RAD002` |
| **TI/Sistemas** | `TI###` o `SIS###` | `TI001`, `SIS_ADMIN` |
| **Enfermer√≠a** | `ENF###` | `ENF001`, `ENF002` |
| **Personal** | Nombre o iniciales | `jperez`, `mgarcia` |

### Reglas Recomendadas:

‚úÖ **Usar:**
- Letras y n√∫meros
- Guiones bajos `_`
- May√∫sculas o min√∫sculas consistentes

‚ùå **Evitar:**
- Espacios
- Caracteres especiales (excepto `_`)
- C√≥digos muy largos (m√°x 20 caracteres)

---

## PASO 6: Testing Completo

### Test 1: Login Exitoso ‚úÖ

1. Abrir `http://localhost:3000/login`
2. Ingresar:
   - **C√≥digo:** `superadmin`
   - **Contrase√±a:** `SuperAdmin2024!`
3. Click "Iniciar sesi√≥n"
4. **Resultado esperado:** Redirige a `/dashboard`

### Test 2: Login con Diferentes Usuarios ‚úÖ

Probar con cada usuario creado:
- `ADMIN001`
- `MED001`
- `RAD001`
- `USR001`

Verificar que cada uno ve diferente men√∫ seg√∫n sus permisos.

### Test 3: Login Fallido ‚úÖ

1. Ingresar c√≥digo correcto pero contrase√±a incorrecta
2. **Resultado esperado:** Mensaje de error
3. **NO debe redirigir**

### Test 4: Usuario No Existente ‚úÖ

1. Ingresar c√≥digo que no existe: `USUARIO_FALSO`
2. **Resultado esperado:** Mensaje de error "Usuario o contrase√±a incorrectos"

### Test 5: Crear Usuario desde Panel ‚úÖ

1. Login como `superadmin`
2. Ir a "Administraci√≥n" ‚Üí "Usuarios"
3. Crear nuevo usuario con c√≥digo `TEST001`
4. Cerrar sesi√≥n
5. Login con `TEST001`
6. Verificar que funciona

---

## PASO 7: Cambiar Contrase√±as

### Usando el Panel (Recomendado)

1. Login con el usuario
2. Ir a "Cambiar Contrase√±a"
3. Ingresar:
   - Contrase√±a actual
   - Nueva contrase√±a
   - Confirmar nueva contrase√±a
4. Guardar cambios

### Usando SQL

```sql
-- Cambiar contrase√±a de un usuario espec√≠fico
UPDATE dim_usuarios
SET 
    pass_user = '$2a$10$TU_PASSWORD_ENCRIPTADO_AQUI',
    password_changed_at = CURRENT_TIMESTAMP,
    failed_attempts = 0
WHERE name_user = 'superadmin';
```

**Para generar password encriptado en BCrypt:**
- Usa: https://bcrypt-generator.com/
- Rounds: 10
- Copiar el hash generado

---

## üìä Resumen de Archivos Modificados

### Backend:
‚úÖ `Usuario.java` - Ya usa `name_user` (TEXT)  
‚úÖ `AuthenticationService.java` - Funciona con c√≥digos  
‚úÖ `LoginRequest.java` - Campo `username`  

### Frontend:
üîÑ `LoginPanel.jsx` - **ACTUALIZADO** (pide c√≥digo en lugar de DNI)  
üîÑ `LoginPanel.css` - **ACTUALIZADO** (estilos mejorados)  

### Base de Datos:
üÜï `04_crear_usuarios_con_codigos.sql` - **NUEVO** (script para crear usuarios)

---

## ‚úÖ Checklist Final

- [ ] Script SQL ejecutado sin errores
- [ ] Usuarios creados en base de datos
- [ ] Frontend actualizado con nuevos archivos
- [ ] Backend corriendo en puerto 8080
- [ ] Frontend corriendo en puerto 3000/5173
- [ ] Login con `superadmin` funciona
- [ ] Otros usuarios tambi√©n funcionan
- [ ] Panel de administraci√≥n accesible
- [ ] Crear usuarios desde panel funciona
- [ ] Cambio de contrase√±a funciona

---

## üÜò Problemas Comunes

### Error: "Usuario no encontrado"
- Verificar que el c√≥digo est√© exactamente como en la BD
- Los c√≥digos distinguen may√∫sculas/min√∫sculas

### Error: CORS
- Verificar que backend tenga CORS configurado para tu frontend
- Ver `SecurityConfig.java` ‚Üí `corsConfigurationSource()`

### Error: "Cannot read property of null"
- Asegurarse de tener `<AuthProvider>` en App.jsx

### Frontend no se actualiza
```bash
# Limpiar cache y reinstalar
rm -rf node_modules package-lock.json
npm install
npm run dev
```

---

## üéØ ¬°Listo!

Tu sistema ahora usa **c√≥digos de usuario** alfanum√©ricos en lugar de DNI.

**Usuarios de prueba disponibles:**
- `superadmin` - Acceso total
- `ADMIN001` - Administrador
- `MED001` - Especialista
- `RAD001` - Radi√≥logo
- `USR001` - Usuario b√°sico

**Todos con contrase√±a:** `SuperAdmin2024!`

**‚ö†Ô∏è Recuerda cambiar las contrase√±as despu√©s del primer login.**

---

**Fecha:** 08/10/2025  
**Versi√≥n:** 1.1.0  
**Sistema:** CENATE - Centro Nacional de Telemedicina
