# v1.46.9 - CHANGELOG FINAL âœ…

**Fecha:** 2026-02-06
**Status:** âœ… COMPLETADO Y TESTEADO
**VersiÃ³n:** v1.46.9
**Branch:** main

---

## ğŸ¯ RESUMEN DE CAMBIOS

### âœ… Problema #1: Pacientes NO aparecÃ­an en "Mis Pacientes"
**Root Cause:** Pacientes importados no estaban asignados a mÃ©dicos (idPersonal = NULL)

**SoluciÃ³n v1.46.9:**
- Agregar campo `idPersonal` a CrearSolicitudAdicionalRequest DTO
- Frontend envÃ­a mÃ©dico seleccionado durante importaciÃ³n
- Backend guarda SolicitudBolsa.idPersonal = doctor_id
- MÃ©dico busca sus pacientes â†’ Â¡Ahora LOS ENCUENTRA! âœ…

**Commits:**
- `5afb013` - fix(v1.46.9): Doctor assignment in import + IPRESS/Fecha complete

---

### âœ… Problema #2: IPRESS mostraba NULL
**Root Cause:** CÃ³digo IPRESS no se guardaba al importar, solo el nombre

**SoluciÃ³n v1.46.8:**
- Nuevo mÃ©todo `obtenerCodigoIpress()` en SolicitudBolsaServiceImpl
- Busca por cÃ³digo exacto â†’ Si no encuentra, busca por nombre
- Retorna cÃ³digo vÃ¡lido para guardar en BD
- Backend guarda cÃ³digo, frontend muestra nombre âœ…

**Commits:**
- `a635c7a` - fix(v1.46.8): Resolver IPRESS NULL en Mis Pacientes + Fecha AsignaciÃ³n

---

### âœ… Problema #3: Fecha AsignaciÃ³n mostraba "-"
**Root Cause:** formatearFecha() no reconocÃ­a formato ISO con Z

**SoluciÃ³n v1.46.8:**
- Actualizar regex para detectar "2026-02-06T10:58:54.563975Z"
- Si termina con Z, usar new Date() nativo de JavaScript
- Fallback a offset format si no es UTC

**Commits:**
- `a635c7a` - fix(v1.46.8): Resolver IPRESS NULL en Mis Pacientes + Fecha AsignaciÃ³n

---

### âœ… Problema #4: Motivo no se actualizaba correctamente
**Root Cause:** Solo actualizaba `condicion`, no `observaciones`

**SoluciÃ³n:**
- Actualizar setPacientes() para incluir `observaciones`
- Cuando DeserciÃ³n â†’ Mostrar razÃ³n
- Cuando Pendiente o Atendido â†’ Limpiar motivo

**Commits:**
- `528e62e` - fix: Actualizar columna Motivo cuando cambia estado a Pendiente
- `de62722` - fix: Limpiar motivo cuando se marca Atendido o Pendiente

---

## ğŸ“ ARCHIVOS MODIFICADOS

### Backend (3 archivos)

**1. CrearSolicitudAdicionalRequest.java**
```java
// âœ… v1.46.9 - Campos para asignar mÃ©dico en importaciÃ³n
private Long idPersonal;
private OffsetDateTime fechaAsignacion;
```

**2. SolicitudBolsaServiceImpl.java**
```java
// âœ… v1.46.9 - Nuevo mÃ©todo obtenerCodigoIpress()
private String obtenerCodigoIpress(String ipressInfo) {
    // Busca por cÃ³digo â†’ Si no, busca por nombre
    // Retorna cÃ³digo vÃ¡lido
}

// âœ… En crearSolicitudAdicional():
Long idPersonalFinal = request.getIdPersonal();
.idPersonal(idPersonalFinal)
.fechaAsignacion(request.getFechaAsignacion() != null ? ... : OffsetDateTime.now())
```

### Frontend (1 archivo)

**MisPacientes.jsx**
```javascript
// âœ… v1.46.8 - Actualizar formatearFecha()
if (fecha.endsWith('Z')) {
  localDate = new Date(fecha);  // ISO nativo
} else {
  // Fallback a offset format
}

// âœ… v1.46.9 - Actualizar observaciones en tabla
setPacientes(pacientes.map(p =>
  p.numDoc === pacienteSeleccionado.numDoc
    ? { ...p, condicion: estadoSeleccionado, observaciones: observaciones }
    : p
));

// âœ… v1.46.9 - Limpiar motivo para Atendido y Pendiente
let observaciones = '';
if (estadoSeleccionado === 'DeserciÃ³n') {
  observaciones = `DeserciÃ³n registrada. RazÃ³n: ${razonDesercion}`;
}
// Pendiente y Atendido quedan con observaciones = ''
```

---

## ğŸ§ª TESTING COMPLETADO

### âœ… Test 1: Importar con MÃ©dico
- [x] Seleccionar especialidad
- [x] Seleccionar mÃ©dico
- [x] Seleccionar fecha/hora
- [x] Guardar sin errores
- [x] Toast: "Paciente importado"

### âœ… Test 2: Ver en Mis Pacientes
- [x] MÃ©dico ve sus pacientes asignados
- [x] IPRESS muestra nombre (no null)
- [x] Fecha AsignaciÃ³n muestra formateada (no "-")
- [x] Tabla se actualiza automÃ¡ticamente

### âœ… Test 3: Cambiar Estado
- [x] Pendiente â†’ DeserciÃ³n + razÃ³n â†’ Motivo aparece âœ…
- [x] DeserciÃ³n â†’ Pendiente â†’ Motivo desaparece âœ…
- [x] Pendiente â†’ Atendido â†’ Motivo desaparece âœ…
- [x] Tabla actualiza en tiempo real

### âœ… Test 4: Backend Logs
- [x] Logs muestran idPersonal asignado
- [x] Logs muestran IPRESS cÃ³digo encontrado
- [x] Logs muestran observaciones guardadas

---

## ğŸ“Š RESULTADOS FINALES

| Feature | Antes | DespuÃ©s |
|---------|-------|---------|
| **Pacientes en Mis Pacientes** | âŒ NO aparecÃ­an | âœ… SÃ­ aparecen |
| **IPRESS** | âŒ null | âœ… "CAP II LURIN" |
| **Fecha AsignaciÃ³n** | âŒ "-" | âœ… "06/02/2026, 10:58 a.m." |
| **Motivo (DeserciÃ³n)** | âŒ No se guardaba | âœ… Se muestra |
| **Motivo (Pendiente/Atendido)** | âŒ No se limpiaba | âœ… Se limpia |
| **Tabla actualiza** | âŒ RequerÃ­a refresh | âœ… En tiempo real |

---

## ğŸ”„ FLUJO COMPLETO (v1.46.9)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COORDINADOR: Importar Paciente â”‚
â”‚                                â”‚
â”‚ - Especialidad: CARDIOLOGIA   â”‚
â”‚ - MÃ©dico: Dr. Juan (45) â† NEW â”‚
â”‚ - Fecha: 06/02/2026 10:30 â† NEW
â”‚                                â”‚
â”‚ Click: "Importar"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
    POST /api/bolsas/solicitudes/crear-adicional
    {
      especialidad: "CARDIOLOGIA",
      idPersonal: 45,  â† NUEVO
      fechaAsignacion: "2026-02-06T10:30:00Z" â† NUEVO
    }
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: SolicitudBolsaServiceImpl              â”‚
â”‚ 1. obtenerCodigoIpress("CAP II LURIN")         â”‚
â”‚    â†’ Retorna "450"                             â”‚
â”‚ 2. Crear SolicitudBolsa:                       â”‚
â”‚    - idPersonal: 45 â† ASIGNADO AL MÃ‰DICO      â”‚
â”‚    - codigoIpress: "450" â† CÃ“DIGO VÃLIDO      â”‚
â”‚    - fechaAsignacion: timestamp                â”‚
â”‚ 3. Guardar en BD                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MÃ‰DICO (45): Mis Pacientes        â”‚
â”‚                                    â”‚
â”‚ GET /api/gestion-pacientes/medico  â”‚
â”‚      /asignados                    â”‚
â”‚                                    â”‚
â”‚ findByIdPersonalAndActivoTrue(45)  â”‚
â”‚ â†’ Encuentra SolicitudBolsa âœ…      â”‚
â”‚                                    â”‚
â”‚ Tabla muestra:                     â”‚
â”‚ DNI: 34567803                      â”‚
â”‚ Paciente: Juan PÃ©rez               â”‚
â”‚ IPRESS: CAP II LURIN âœ…            â”‚
â”‚ Fecha: 06/02/2026, 10:30 a.m. âœ…  â”‚
â”‚ Motivo: - (vacÃ­o) âœ…              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cambiar a DeserciÃ³n + RazÃ³n        â”‚
â”‚ â†’ Motivo: "RazÃ³n: No contactado" âœ…â”‚
â”‚                                    â”‚
â”‚ Cambiar a Pendiente                â”‚
â”‚ â†’ Motivo: "-" (limpiado) âœ…        â”‚
â”‚                                    â”‚
â”‚ Cambiar a Atendido                 â”‚
â”‚ â†’ Motivo: "-" (limpiado) âœ…        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ COMMITS HISTORIA

| Hash | Mensaje | Feature |
|------|---------|---------|
| a635c7a | fix(v1.46.8): IPRESS NULL + Fecha formatting | IPRESS + Fecha |
| a3e4eec | docs(v1.46.8): DocumentaciÃ³n de fixes | Docs |
| d518a3c | docs(v1.46.8): ComparaciÃ³n antes/despuÃ©s visual | Docs |
| 5afb013 | fix(v1.46.9): Doctor assignment in import | Doctor Assignment |
| 528e62e | fix: Actualizar columna Motivo cuando cambia | Motivo Update |
| de62722 | fix: Limpiar motivo cuando se marca Atendido | Motivo Cleanup |

---

## âœ… CHECKLIST FINAL

- [x] Backend builds successfully
- [x] Frontend builds successfully
- [x] Backend running on port 8080
- [x] IPRESS muestra correctamente (no null)
- [x] Fecha AsignaciÃ³n formateada (no "-")
- [x] MÃ©dico ve sus pacientes en Mis Pacientes
- [x] Motivo aparece cuando DeserciÃ³n
- [x] Motivo se limpia cuando Pendiente
- [x] Motivo se limpia cuando Atendido
- [x] Tabla se actualiza en tiempo real
- [x] DocumentaciÃ³n actualizada

---

## ğŸ“ NOTAS IMPORTANTES

### Para MÃ©dicos
1. Al importar pacientes, **SIEMPRE** selecciona tu nombre en el campo "MÃ©dico"
2. Sin esto, no verÃ¡s los pacientes en "Mis Pacientes"
3. Puedes cambiar el estado y ver el motivo en la tabla

### Para Coordinadores
1. Cuando importas pacientes, asegÃºrate de asignar el mÃ©dico responsable
2. Selecciona la fecha/hora de asignaciÃ³n
3. El paciente aparecerÃ¡ automÃ¡ticamente en "Mis Pacientes" del mÃ©dico

### Para DevOps
1. AsegÃºrate de que el puerto 8080 no estÃ¡ en uso al reiniciar
2. Si hay error "Port already in use", mata: `pkill -9 -f java`
3. Luego reinicia: `cd backend && ./gradlew bootRun`

---

## ğŸ‰ Â¡COMPLETADO!

**v1.46.9** incluye:
- âœ… Doctor assignment durante importaciÃ³n
- âœ… IPRESS code lookup automÃ¡tico
- âœ… Fecha AsignaciÃ³n formateada correctamente
- âœ… Motivo (observaciones) sincronizado con estado
- âœ… Tabla Mis Pacientes completamente funcional

**Status:** READY FOR PRODUCTION

---

**Last Update:** 2026-02-06 07:30 AM
**Final Status:** âœ… ALL FEATURES WORKING
