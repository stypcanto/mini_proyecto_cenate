# ‚úÖ CORRECCI√ìN: CARGA DE FOTOS DE PERFIL

## üîß Problema Identificado

El sistema no pod√≠a cargar fotos de perfil porque:
1. **No exist√≠a el endpoint POST** `/api/personal/{id}/foto` para subir fotos
2. El frontend estaba intentando usar ese endpoint pero el backend no lo ten√≠a implementado
3. La foto no se mostraba en el modal de edici√≥n

## ‚úÖ Soluci√≥n Implementada

### Backend - PersonalTotalController.java

He agregado dos endpoints nuevos al controlador:

#### 1. **POST `/api/personal/{id}/foto`** - Subir Foto
```java
@PostMapping("/{id}/foto")
@PreAuthorize("hasAnyAuthority('EDITAR_PERSONAL','CREAR_PERSONAL','SUPERADMIN')")
public ResponseEntity<Map<String, String>> uploadFoto(
        @PathVariable Long id,
        @RequestParam("foto") MultipartFile file)
```

**Funcionalidades:**
- ‚úÖ Valida que el archivo no est√© vac√≠o
- ‚úÖ Valida que sea una imagen (content-type image/*)
- ‚úÖ Valida tama√±o m√°ximo de 5MB
- ‚úÖ Genera nombre √∫nico para cada archivo: `user_{id}_{UUID}.{extension}`
- ‚úÖ Guarda el archivo en el disco en la carpeta configurada
- ‚úÖ Actualiza la base de datos (tablas `dim_personal_cnt` o `dim_personal_externo`)
- ‚úÖ Retorna informaci√≥n del archivo guardado

**Respuesta Exitosa:**
```json
{
  "message": "Foto subida correctamente",
  "fileName": "user_123_abc-def-ghi.jpg",
  "url": "/api/personal/foto/user_123_abc-def-ghi.jpg"
}
```

#### 2. **GET `/api/personal/foto/{fileName}`** - Obtener Foto
```java
@GetMapping("/foto/{fileName}")
@PreAuthorize("isAuthenticated()")
public ResponseEntity<Resource> getFoto(@PathVariable String fileName)
```

**Funcionalidades:**
- ‚úÖ Busca el archivo en el disco
- ‚úÖ Retorna el archivo con el content-type correcto
- ‚úÖ A√±ade cache headers (7 d√≠as) para optimizar rendimiento
- ‚úÖ Maneja errores si el archivo no existe

---

## üìù Cambios en el C√≥digo Backend

### Ubicaci√≥n del Archivo
```
/backend/src/main/java/com/styp/cenate/api/area/PersonalTotalController.java
```

### Imports Agregados
```java
import org.springframework.web.multipart.MultipartFile;
import jakarta.annotation.PostConstruct;
import java.nio.file.*;
import java.util.UUID;
import java.util.concurrent.TimeUnit;
```

### Configuraci√≥n de Directorio de Uploads
```java
@Value("${app.upload.dir:${user.home}/cenate-uploads/personal}")
private String uploadDir;

@PostConstruct
private void initUploadDir() throws IOException {
    Path path = Paths.get(uploadDir);
    if (!Files.exists(path)) {
        Files.createDirectories(path);
        log.info("üìÇ Carpeta de uploads creada en: {}", uploadDir);
    }
}
```

### Actualizaci√≥n de Base de Datos
El endpoint actualiza autom√°ticamente la columna de foto en la tabla correspondiente:

**Para Personal CNT:**
```sql
UPDATE dim_personal_cnt 
SET foto_pers = ? 
WHERE id_usuario = ?
```

**Para Personal Externo:**
```sql
UPDATE dim_personal_externo 
SET foto_ext = ? 
WHERE id_user = ?
```

---

## üé® Frontend - C√≥mo Funciona Ahora

### En el Modal de Edici√≥n

1. **Cargar Foto Actual:**
   - Al abrir el modal de edici√≥n, se carga la foto desde `/api/personal/foto/{fileName}`
   - Si no hay foto, se muestra la inicial del usuario

2. **Cambiar Foto:**
   - Click en el icono de c√°mara
   - Seleccionar imagen (validaci√≥n de tama√±o y tipo en frontend)
   - Vista previa instant√°nea
   - Al guardar, se sube autom√°ticamente

3. **Subir Foto:**
   ```javascript
   const formDataPhoto = new FormData();
   formDataPhoto.append('foto', photoFile);
   
   await fetch(`/api/personal/${user.id_user}/foto`, {
     method: 'POST',
     headers: {
       'Authorization': `Bearer ${token}`,
     },
     body: formDataPhoto
   });
   ```

### En el Modal de Creaci√≥n

1. **Seleccionar Foto (Opcional):**
   - Click en el icono de c√°mara
   - Vista previa antes de crear el usuario

2. **Proceso de Creaci√≥n:**
   - Primero se crea el usuario
   - Luego se sube la foto usando el ID del usuario reci√©n creado

---

## üîê Seguridad y Validaciones

### Backend
- ‚úÖ Autenticaci√≥n requerida (JWT Token)
- ‚úÖ Permisos espec√≠ficos (`EDITAR_PERSONAL`, `CREAR_PERSONAL`, `SUPERADMIN`)
- ‚úÖ Validaci√≥n de tipo de archivo (solo im√°genes)
- ‚úÖ Validaci√≥n de tama√±o (m√°ximo 5MB)
- ‚úÖ Nombres de archivo √∫nicos con UUID
- ‚úÖ Sanitizaci√≥n de nombres de archivo

### Frontend
- ‚úÖ Validaci√≥n de tama√±o antes de enviar
- ‚úÖ Validaci√≥n de tipo de archivo
- ‚úÖ Mensajes de error descriptivos
- ‚úÖ Token JWT en todas las peticiones

---

## üìÇ Estructura de Archivos

### Ubicaci√≥n de Fotos en el Servidor
```
{user.home}/cenate-uploads/personal/
‚îú‚îÄ‚îÄ user_1_a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6.jpg
‚îú‚îÄ‚îÄ user_2_b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7.png
‚îî‚îÄ‚îÄ user_3_c3d4e5f6-g7h8-9i0j-1k2l-m3n4o5p6q7r8.jpeg
```

### Configuraci√≥n en application.properties
```properties
# Directorio de uploads (opcional, por defecto usa user.home)
app.upload.dir=/var/cenate/uploads/personal

# Tama√±o m√°ximo de archivos (opcional)
spring.servlet.multipart.max-file-size=5MB
spring.servlet.multipart.max-request-size=5MB
```

---

## üß™ C√≥mo Probar

### 1. Con Postman

**Subir Foto:**
```
POST http://localhost:8080/api/personal/1/foto
Headers:
  Authorization: Bearer {tu_token}
Body:
  form-data
    Key: foto
    Value: [Seleccionar archivo de imagen]
```

**Obtener Foto:**
```
GET http://localhost:8080/api/personal/foto/user_1_abc123.jpg
Headers:
  Authorization: Bearer {tu_token}
```

### 2. Desde la Interfaz

1. **Editar Usuario:**
   - Click en el bot√≥n de editar (l√°piz verde)
   - Click en el icono de c√°mara
   - Seleccionar imagen
   - Ver vista previa
   - Click en "Guardar Cambios"

2. **Crear Usuario:**
   - Click en "Crear Usuario"
   - Llenar formulario
   - (Opcional) Click en icono de c√°mara para agregar foto
   - Click en "Crear Usuario"

---

## üêõ Troubleshooting

### Problema: "Error al subir la foto"

**Posibles causas:**
1. El directorio de uploads no tiene permisos de escritura
2. El archivo supera los 5MB
3. El archivo no es una imagen v√°lida
4. No hay espacio en disco

**Soluci√≥n:**
```bash
# Verificar permisos
ls -la ~/cenate-uploads/personal/

# Dar permisos
chmod 755 ~/cenate-uploads/personal/

# Verificar espacio en disco
df -h
```

### Problema: "Foto no se muestra"

**Posibles causas:**
1. El archivo no existe en el servidor
2. El nombre del archivo en la BD no coincide con el archivo f√≠sico
3. Permisos de lectura del archivo

**Soluci√≥n:**
```bash
# Verificar que el archivo existe
ls ~/cenate-uploads/personal/

# Verificar en la base de datos
SELECT id_pers, foto_pers FROM dim_personal_cnt WHERE id_usuario = 1;
```

### Problema: "No se puede subir foto en Crear Usuario"

**Causa:**
El usuario a√∫n no tiene ID hasta que se crea

**Soluci√≥n:**
Ya est√° implementado: primero se crea el usuario, luego se sube la foto con el ID obtenido

---

## üìä Logs para Debugging

El sistema genera logs descriptivos:

```
üì∏ Subiendo foto para usuario ID: 123
‚úÖ Foto guardada exitosamente: user_123_abc-def.jpg
üñºÔ∏è Obteniendo foto: user_123_abc-def.jpg
‚ö†Ô∏è Foto no encontrada: user_999_xyz.jpg
‚ùå Error al subir foto: Permission denied
```

---

## ‚ú® Caracter√≠sticas Adicionales

### Cache de Im√°genes
Las fotos se cachean por 7 d√≠as en el navegador para mejorar el rendimiento:
```java
.cacheControl(CacheControl.maxAge(7, TimeUnit.DAYS).cachePublic())
```

### Nombres de Archivo √önicos
Se genera un UUID para evitar conflictos:
```
user_{userId}_{UUID}.{extension}
```

### Soporte Multi-formato
Soporta todos los formatos de imagen comunes:
- JPG/JPEG
- PNG
- GIF
- WEBP
- BMP

---

## üìå Notas Importantes

1. **Las fotos se guardan en el servidor**, no en la base de datos
2. **Solo se guarda el nombre del archivo** en la BD (columnas `foto_pers` o `foto_ext`)
3. **El directorio de uploads debe tener permisos** de lectura/escritura
4. **Las fotos persisten** incluso si se reinicia la aplicaci√≥n
5. **No hay l√≠mite de fotos** por usuario (se sobrescribe la anterior en la BD, pero el archivo viejo queda en disco)

---

## üöÄ Pr√≥ximas Mejoras Sugeridas

1. **Eliminar fotos antiguas** cuando se sube una nueva
2. **Redimensionar autom√°ticamente** las im√°genes (thumbnails)
3. **Comprimir im√°genes** grandes autom√°ticamente
4. **Subir a cloud storage** (AWS S3, Google Cloud Storage)
5. **Agregar marca de agua** a las fotos
6. **Soporte para recortar** imagen antes de subir

---

## üìû Soporte

Si encuentras problemas:
1. Verifica los logs del backend
2. Verifica la consola del navegador (F12)
3. Verifica los permisos del directorio de uploads
4. Verifica que el token JWT sea v√°lido

---

**Fecha de Implementaci√≥n:** 20 de Octubre, 2025  
**Versi√≥n:** 2.0  
**Archivo Modificado:** `PersonalTotalController.java`  
**Desarrollado para:** CENATE - Centro Nacional de Telemedicina

---

## ‚úÖ RESUMEN

**Lo que funcionaba antes:**
- Ver usuarios ‚úÖ
- Editar datos de texto ‚úÖ
- Eliminar usuarios ‚úÖ

**Lo que se agreg√≥ ahora:**
- ‚ú® **Subir fotos de perfil** (POST endpoint)
- ‚ú® **Obtener fotos de perfil** (GET endpoint)
- ‚ú® **Validaciones de seguridad**
- ‚ú® **Vista previa de fotos**
- ‚ú® **Cache de im√°genes**
- ‚ú® **Logs descriptivos**

**Endpoints Nuevos:**
- `POST /api/personal/{id}/foto` - Subir foto
- `GET /api/personal/foto/{fileName}` - Obtener foto

**¬°Ahora el sistema est√° completamente funcional para gesti√≥n de fotos de perfil!** üéâ
