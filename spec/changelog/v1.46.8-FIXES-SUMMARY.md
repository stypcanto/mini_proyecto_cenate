# v1.46.8 - IPRESS y Fecha Asignaci√≥n Fix üîß

**Fecha:** 2026-02-06
**Commit:** a635c7a
**Status:** ‚úÖ Backend BUILD SUCCESS | ‚úÖ Frontend BUILD SUCCESS

---

## üéØ Problemas Identificados y Solucionados

### 1Ô∏è‚É£ IPRESS retornando NULL en Mis Pacientes
**Problema:**
- API devolv√≠a `"ipress": null` en la tabla de Mis Pacientes
- Causa: `obtenerCodigoIpress()` recib√≠a null cuando se importaba un paciente
- El backend NO guardaba el c√≥digo IPRESS al importar

**Soluci√≥n (v1.46.8):**
```java
// ‚úÖ Nuevo m√©todo: obtenerCodigoIpress() en SolicitudBolsaServiceImpl
private String obtenerCodigoIpress(String ipressInfo) {
    if (ipressInfo == null || ipressInfo.trim().isEmpty()) {
        return null;
    }

    // 1. Buscar por c√≥digo directo
    var ipressByCode = ipressRepository.findByCodIpress(ipressInfo);
    if (ipressByCode.isPresent()) {
        return ipressInfo;
    }

    // 2. Buscar por descripci√≥n/nombre
    var ipresList = ipressRepository.findByDescIpressContainingIgnoreCase(ipressInfo);
    if (!ipresList.isEmpty()) {
        return ipresList.get(0).getCodIpress();
    }

    return null;
}
```

**Cambios en `crearSolicitudAdicional()`:**
```java
// Antes (v1.46.5):
.codigoIpressAdscripcion(request.getDescIpress()) // ‚ùå IPRESS nombre, no c√≥digo

// Despu√©s (v1.46.8):
String codigoIpressValido = obtenerCodigoIpress(request.getDescIpress());
.codigoIpressAdscripcion(codigoIpressValido) // ‚úÖ IPRESS c√≥digo v√°lido
```

**Resultado:**
- ‚úÖ Busca autom√°ticamente por c√≥digo O por nombre
- ‚úÖ Valida en database antes de guardar
- ‚úÖ IPRESS ya no es null en "Mis Pacientes"

---

### 2Ô∏è‚É£ Fecha Asignaci√≥n mostrando "-" en Mis Pacientes
**Problema:**
- API devolv√≠a: `"fechaAsignacion": "2026-02-06T10:58:54.563975Z"` ‚úÖ
- Pero en la tabla aparec√≠a como: "-" ‚ùå
- Causa: Funci√≥n `formatearFecha()` NO reconoc√≠a formato ISO con Z y millisegundos

**Regex Anterior (FALLABA):**
```javascript
// Solo aceptaba: "2026-02-05T02:09:54-05:00" (con offset ¬±HH:MM)
const match = fecha.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})([+-]\d{2}):?(\d{2})?/);
```

**Soluci√≥n (v1.46.8):**
```javascript
const formatearFecha = (fecha) => {
    if (!fecha) return '-';

    try {
        // ‚úÖ Ahora soporta AMBOS formatos:

        // 1. ISO UTC con Z y millisegundos: "2026-02-06T10:58:54.563975Z"
        if (fecha.endsWith('Z')) {
            localDate = new Date(fecha);  // JavaScript lo parsea nativamente
        } else {
            // 2. ISO con offset: "2026-02-05T02:09:54-05:00"
            const offsetMatch = fecha.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})([+-]\d{2}):?(\d{2})?/);
            // ... aplicar offset
        }

        if (isNaN(localDate.getTime())) return '-';

        // Formatear: "06/02/2026, 10:58:54 a. m."
        return formatearComponentes(localDate);
    } catch (e) {
        return '-';
    }
};
```

**Resultado:**
- ‚úÖ Detecta autom√°ticamente formato ISO con Z
- ‚úÖ Soporta offset tradicional tambi√©n
- ‚úÖ Fecha Asignaci√≥n ahora visible en tabla

---

## üìù Archivos Modificados

### Backend
1. **SolicitudBolsaServiceImpl.java**
   - L√≠nea 2900: Nuevo m√©todo `obtenerCodigoIpress(String ipressInfo)`
   - L√≠nea 2904: Llamar `obtenerCodigoIpress()` antes de guardar
   - L√≠nea 2911-2912: Usar c√≥digo IPRESS v√°lido

2. **GestionPacienteDTO.java** (ya ten√≠a anotaciones de v1.46.7)
   - `@JsonProperty("ipress")`
   - `@JsonProperty("fechaAsignacion")`
   - `@JsonFormat(pattern = "yyyy-MM-dd'T'HH:mm:ss.SSSZZZ")`

### Frontend
1. **MisPacientes.jsx**
   - L√≠nea 76-108: Actualizar `formatearFecha()` con ambos formatos ISO

---

## üß™ Testing Plan

### Test 1: Importar paciente con IPRESS
**Pasos:**
1. Ir a: `http://localhost:3000/roles/citas/gestion-asegurado`
2. Buscar: `34567803`
3. Importar con campos:
   - DNI: 34567803
   - Nombre: [auto-filled]
   - IPRESS: **CAP II LURIN** (nombre, no c√≥digo)
   - Especialidad: CARDIOLOGIA
4. Guardar

**Verificar:**
- ‚úÖ Importaci√≥n exitosa
- ‚úÖ No hay error "IPRESS null"
- ‚úÖ En BD se guarda c√≥digo IPRESS (ej: "450")

### Test 2: Ver Mis Pacientes como M√©dico
**Pasos:**
1. Logout y login con m√©dico:
   - DNI: 45433320
   - Pass: Cenate@2024
2. Ir a: `http://localhost:3000/roles/medico/pacientes`
3. Buscar paciente importado (34567803)

**Verificar:**
- ‚úÖ Tabla muestra: IPRESS = "CAP II LURIN" (no null, no "-")
- ‚úÖ Tabla muestra: Fecha Asignaci√≥n = "06/02/2026, 07:58:54 a. m." (no "-")
- ‚úÖ Ambas columnas con datos correctos

### Test 3: Import con IPRESS c√≥digo (fallback)
**Pasos:**
1. Intentar importar otro paciente con c√≥digo IPRESS:
   - IPRESS: "450" (c√≥digo, no nombre)
2. Verificar que tambi√©n funciona

**Verificar:**
- ‚úÖ Busca por c√≥digo directo
- ‚úÖ Guarda correctamente

---

## üîç Debug Logs Esperados

Cuando se importa un paciente, buscar en logs del backend:

```
üìù Creando solicitud adicional para DNI: 34567803

‚úÖ Paciente validado: Juan P√©rez - DNI: 34567803

üîç [Auto-Assign] Usuario encontrado: styp_canto ‚Üí ID: 1

üîç [v1.46.8] IPRESS input: 'CAP II LURIN' ‚Üí c√≥digo final: '450'  ‚úÖ

‚úÖ Solicitud adicional creada: 1234 - Asignada a gestor ID: 1 - IPRESS: 450 ‚úÖ
```

---

## üìä Build Status

| Componente | Status | Detalles |
|-----------|--------|----------|
| **Backend** | ‚úÖ SUCCESS | `./gradlew clean build -x test` |
| **Frontend** | ‚úÖ SUCCESS | `npm run build` |
| **Port 8080** | ‚úÖ OK | Backend respond a `/api/health` |
| **Port 3000** | ‚úÖ OK | Frontend dev server running |

---

## üöÄ Pr√≥ximos Pasos (v1.46.9)

Si al probar encuentras otros issues:

1. **M√©dico y Fecha en modal de importaci√≥n**
   - Los campos est√°n en frontend pero faltan conectar al backend
   - Crear DTO fields: `medicoId`, `fechaAsignacion`

2. **M√©dico selector en tabla Mis Pacientes**
   - Agregar dropdown de m√©dicos por paciente
   - Endpoint: `GET /api/personal/medicos`

3. **Sincronizaci√≥n autom√°tica**
   - Cuando m√©dico marca "Atendido", sincronizar a `solicitud_cita`

---

## üìû Informaci√≥n de Contacto

**Versi√≥n:** v1.46.8
**Fecha:** 2026-02-06
**Commit:** a635c7a
**Branch:** main
