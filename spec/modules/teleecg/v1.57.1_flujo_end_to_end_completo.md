# ğŸ”Œ TeleECG End-to-End Completo (v1.57.1 - v1.60.0)

> **Status:** âœ… PRODUCTION READY
> **Ãšltimas versiones:** v1.57.1 (Fix imÃ¡genes), v1.58.0-1 (Bolsas), v1.58.2 (Notificaciones), v1.59.0 (Panel), v1.60.0 (Enriquecimiento datos)
> **Fecha:** 2026-02-07

---

## ğŸ¯ Flujo Completo: IPRESS â†’ CENATE â†’ MÃ©dico

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: IPRESS Carga ECG                                    â”‚
â”‚ /teleecgs/upload                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Validar paciente existe                                  â”‚
â”‚ âœ… Calcular SHA256 (detectar duplicados)                    â”‚
â”‚ âœ… Guardar imagen en BD (contenidoImagen BYTEA)             â”‚
â”‚ âœ… Registrar en tele_ecg_imagenes (estado: ENVIADA)         â”‚
â”‚ âœ… Crear bolsa automÃ¡tica en dim_solicitud_bolsa            â”‚
â”‚ âœ… Enviar email a coordinador                               â”‚
â”‚ âœ… Mostrar modal con resultado                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Coordinador Recibe NotificaciÃ³n                     â”‚
â”‚ Email â†’ CENATE Panel â†’ GET /api/gestion-pacientes/teleecgs â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Email con detalles del paciente                          â”‚
â”‚ âœ… Marca URGENTE si aplica                                  â”‚
â”‚ âœ… Link directo a /citas/gestion-asegurado                  â”‚
â”‚ âœ… Panel ECGs con filtros y bÃºsqueda                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Coordinador/MÃ©dico Visualiza ECG                    â”‚
â”‚ PanelECGsCoordinador.jsx                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Tabla responsiva con ECGs disponibles                    â”‚
â”‚ âœ… Filtros: Estado, DNI                                     â”‚
â”‚ âœ… PaginaciÃ³n (10 registros/pÃ¡gina)                         â”‚
â”‚ âœ… Modal: preview imagen + detalles                         â”‚
â”‚ âœ… Botones: Ver, Descargar, Atender                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: MÃ©dico Atiende ECG                                  â”‚
â”‚ PUT /api/gestion-pacientes/{id}/atendido                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Modal: Atender Paciente (Modal existente v1.47.2)        â”‚
â”‚ âœ… Seleccionar: Recita (dÃ­as), Interconsulta (especialidad) â”‚
â”‚ âœ… Enfermedades crÃ³nicas (multiselect)                      â”‚
â”‚ âœ… Crear bolsas automÃ¡ticas para Recita/Interconsulta       â”‚
â”‚ âœ… Sincronizar estado a ATENDIDA                            â”‚
â”‚ âœ… Coordinador ve nuevas solicitudes en su bandeja          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Bolsas Generadas AutomÃ¡ticamente                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Bolsa 1: RECITA (especialidad original del mÃ©dico)       â”‚
â”‚ âœ… Bolsa 2: INTERCONSULTA (especialidad seleccionada)       â”‚
â”‚ âœ… Ambas aparecen en bandeja del coordinador                â”‚
â”‚ âœ… Ambas tienen fecha_preferida calculada                   â”‚
â”‚ âœ… Coordinador puede hacer follow-up automÃ¡tico             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ Versiones Implementadas

### v1.60.0 - Enriquecimiento AutomÃ¡tico de Datos + Sync Bolsa 107
**Objetivo:** Garantizar que bolsas TeleECG siempre tengan datos actualizados y sincronizados

**Cambios Backend:**

1. **TeleECGService.crearBolsaTeleECG()** (lÃ­neas 915-946)
   - âœ… Extrae datos del asegurado automÃ¡ticamente
   - âœ… Asigna `tipo_documento = "DNI"`
   - âœ… Asigna `paciente_sexo` desde asegurados
   - âœ… Asigna `paciente_telefono` (celular o fijo)
   - âœ… Asigna `fecha_nacimiento` del asegurado
   - âœ… Asigna `tipo_cita = "Voluntaria"` por defecto

2. **SolicitudBolsaServiceImpl.procesarFilaExcel()** (lÃ­nea 1067)
   - âœ… Asigna `tipo_cita = "Voluntaria"` cuando viene NULL desde Excel

3. **SolicitudBolsaServiceImpl.sincronizarAseguradoEnTransaccionSeparada()** (lÃ­neas 1755-1772)
   - âœ… Ya actualizaba telÃ©fonos desde Bolsa 107
   - âœ… Ahora TeleECG usa estos datos frescos

**Flujo de Datos - v1.60.0:**
```
Bolsa 107 (Excel)
    â†“ actualiza telÃ©fonos frescos en
asegurados (BD - FUENTE DE VERDAD)
    â†“ TeleECG lee datos actualizados
/teleecgs/upload (DNI)
    â†“ busca asegurado en BD
TeleECGService.crearBolsaTeleECG()
    â†“ enriquece bolsa con datos asegurado
dim_solicitud_bolsa (TIPO_CITA=Voluntaria, datos completos)
```

**GarantÃ­as:**
- âœ… Bolsa 107 = Fuente primaria de telÃ©fonos
- âœ… asegurados = Tabla sincronizada automÃ¡ticamente
- âœ… TeleECG = Lee datos frescos siempre
- âœ… Bolsas = Todas tienen tipo_cita="Voluntaria" por defecto

**Resultado:** Datos siempre actualizados sin intervenciÃ³n manual âœ…

---

## ğŸ“¦ Versiones Implementadas

### v1.57.1 - Fix Modal de ImÃ¡genes
**Problema:** ImÃ¡genes no se visualizaban en modal ("No hay imagen disponible")

**Cambios:**
- `todasLasImagenes` state: Guardar TODAS las imÃ¡genes enriquecidas (no deduplicadas)
- `handleVerImagen()`: Filtrar de `todasLasImagenes` en lugar de `ecgs`
- Modal invocation: Pasar `imagenes={selectedImage.imagenes || [selectedImage]}`

**Resultado:** ImÃ¡genes se cargan y visualizan correctamente âœ…

---

### v1.58.0 - Crear Bolsa AutomÃ¡tica
**Objetivo:** Coordinadores vean ECGs en su bandeja

**Cambios Backend:**
1. **Migration V4_0_0:** Agregar tipo BOLSA_TELEECG a dim_tipos_bolsas
   ```sql
   INSERT INTO dim_tipos_bolsas (cod_tipo_bolsa, desc_tipo_bolsa, stat_tipo_bolsa)
   VALUES ('BOLSA_TELEECG', 'Bolsa TeleECG - Electrocardiogramas remotos', 'A');
   ```

2. **TeleECGService.crearBolsaTeleECG():**
   - Genera `numeroSolicitud` Ãºnico (TEL-timestamp)
   - Busca coordinador responsable del IPRESS
   - Crea SolicitudBolsa con estado PENDIENTE
   - Cae gracefully si falla (continÃºa upload)

3. **Integration Point:** DespuÃ©s de guardar imagen (lÃ­nea 182)
   ```java
   crearBolsaTeleECG(imagen, asegurado, ipress);
   ```

**Resultado:** Bolsa aparece en bandeja del coordinador âœ…

---

### v1.58.1 - Endpoints para Coordinadores
**Objetivo:** API para que coordinadores vean y atiendan ECGs

**Nuevos Endpoints:**
1. `GET /api/gestion-pacientes/teleecgs`
   - ParÃ¡metros: `numDoc`, `estado`, `page`, `size`
   - Respuesta: Paginada con array de ECGs
   - MBAC: `/citas/gestion-asegurado` (ver)

2. `GET /api/gestion-pacientes/teleecgs/{idImagen}`
   - Obtener detalles de ECG especÃ­fico
   - Registra visualizaciÃ³n en auditorÃ­a

3. `PUT /api/gestion-pacientes/teleecgs/{idImagen}/atender`
   - Reutiliza AtenderPacienteService existente
   - Crea Recita/Interconsulta si aplica
   - MBAC: `/citas/gestion-asegurado` (editar)

---

### v1.58.2 - Notificaciones por Email
**Objetivo:** Coordinador notificado inmediatamente

**Cambios:**
1. **EmailService.enviarNotificacionECGNuevo()**
   - Template HTML profesional
   - Info del paciente (nombre, DNI, IPRESS)
   - Marca URGENTE en asunto si aplica
   - Link directo a CENATE

2. **Integration:** En `crearBolsaTeleECG()`
   ```java
   emailService.enviarNotificacionECGNuevo(
     coordinador.getEmail(),
     coordinador.getNombreCompleto(),
     asegurado.getNombreCompleto(),
     asegurado.getDocPaciente(),
     ipress.getDescIpress(),
     imagen.getEsUrgente()
   );
   ```

**Resultado:** Email recibido con detalles ECG âœ…

---

### v1.59.0 - Panel Frontend para Coordinadores
**Objetivo:** Interfaz para gestionar ECGs

**Componente:** `PanelECGsCoordinador.jsx`

**Features:**
- âœ… Tabla responsiva de ECGs
- âœ… Filtros: Estado (ENVIADA/OBSERVADA/ATENDIDA), DNI
- âœ… PaginaciÃ³n (10 registros/pÃ¡gina)
- âœ… Indicador visual URGENTE (fondo rojo)
- âœ… Modal vista previa con imagen
- âœ… Acciones: Ver, Descargar, Atender
- âœ… InformaciÃ³n paciente: DNI, nombre, IPRESS

**IntegraciÃ³n:**
```jsx
import PanelECGsCoordinador from '@/components/teleecgs/PanelECGsCoordinador';

<PanelECGsCoordinador onAtenderClick={(ecg) => {
  // Abre modal AtenderPaciente con datos del ECG
}} />
```

---

## ğŸ“Š Base de Datos

### Migration V4_0_0
```sql
-- Crear tipo de bolsa TELEECG
INSERT INTO dim_tipos_bolsas (cod_tipo_bolsa, desc_tipo_bolsa, stat_tipo_bolsa)
SELECT 'BOLSA_TELEECG', 'Bolsa TeleECG - Electrocardiogramas remotos', 'A'
WHERE NOT EXISTS (SELECT 1 FROM dim_tipos_bolsas WHERE cod_tipo_bolsa = 'BOLSA_TELEECG');

-- Crear Ã­ndice para bÃºsquedas rÃ¡pidas
CREATE INDEX idx_solicitud_bolsa_teleecg
ON dim_solicitud_bolsa(id_bolsa, estado);

-- Agregar columna de referencia (opcional)
ALTER TABLE dim_solicitud_bolsa
ADD COLUMN IF NOT EXISTS id_teleecg_imagen BIGINT DEFAULT NULL;
```

### Flujo de Datos
```
tele_ecg_imagenes
â””â”€â†’ (ENVIADA) â†’ crearBolsaTeleECG() â†’ dim_solicitud_bolsa
    â”œâ”€ numeroSolicitud: TEL-{timestamp}
    â”œâ”€ id_bolsa: BOLSA_TELEECG
    â”œâ”€ estado: PENDIENTE
    â””â”€ responsableGestoraId: Coordinador IPRESS

dim_solicitud_bolsa
â””â”€â†’ (PENDIENTE) â†’ Coordinador ve en bandeja
    â””â”€â†’ (Click Atender) â†’ AtenderPacienteService.atenderPaciente()
        â”œâ”€ Crear RECITA (bolsa tipo 11)
        â”œâ”€ Crear INTERCONSULTA (bolsa tipo 11)
        â””â”€ Actualizar estado a ATENDIDA
```

---

## ğŸ” Seguridad (MBAC)

**Permiso requerido:** `/citas/gestion-asegurado`
- **Ver:** Acceso a GET endpoints
- **Editar:** Acceso a PUT (atender)

**Roles que tienen acceso:**
- COORDINADOR_GESTION_CITAS
- MEDICO
- SUPERADMIN

---

## ğŸ§ª Checklist End-to-End

### Backend
- [ ] Migration V4_0_0 ejecuta sin errores
- [ ] TeleECGService.crearBolsaTeleECG() crea bolsa
- [ ] EmailService.enviarNotificacionECGNuevo() envÃ­a email
- [ ] Endpoints /api/gestion-pacientes/teleecgs responden

### Frontend
- [ ] PanelECGsCoordinador carga ECGs desde API
- [ ] Filtros funcionan correctamente
- [ ] Modal previa muestra imagen
- [ ] Click "Atender" abre flujo AtenderPaciente
- [ ] Responsive en mobile/tablet

### IntegraciÃ³n
- [ ] IPRESS carga ECG
- [ ] Bolsa aparece en CENATE
- [ ] Coordinador recibe email
- [ ] Panel muestra ECG
- [ ] MÃ©dico atiende
- [ ] Recita/Interconsulta se crean
- [ ] Estados sincronizados

---

## ğŸ“ CÃ³digo de Ejemplo

### Upload ECG (IPRESS)
```javascript
// IPRESS carga ECG
POST /api/teleekgs/upload
{
  "numDocPaciente": "12345678",
  "nombresPaciente": "Juan",
  "apellidosPaciente": "PÃ©rez",
  "esUrgente": true,
  "observaciones": "Taquicardia leve"
}
// Respuesta:
{
  "idImagen": 123,
  "estado": "ENVIADA",
  "estado_transformado": "ENVIADA",
  "contenidoImagen": "base64..."
}
```

### Listar ECGs (Coordinador)
```javascript
// GET /api/gestion-pacientes/teleecgs?estado=ENVIADA&page=0&size=10
{
  "content": [
    {
      "idImagen": 123,
      "numDocPaciente": "12345678",
      "nombresPaciente": "Juan",
      "apellidosPaciente": "PÃ©rez",
      "estado": "ENVIADA",
      "esUrgente": true,
      "nombreIpress": "CAP II LURÃN",
      "fechaEnvio": "2026-02-06T10:30:00Z"
    }
  ],
  "totalElements": 15,
  "totalPages": 2
}
```

### Atender ECG (MÃ©dico)
```javascript
// PUT /api/gestion-pacientes/123/atendido
{
  "condicion": "Taquicardia diagnosticada",
  "tieneRecita": true,
  "diasRecita": "7",
  "tieneInterconsulta": true,
  "interconsultaEspecialidad": "CARDIOLOGÃA",
  "esCronico": true,
  "enfermedades": ["HipertensiÃ³n", "Diabetes"]
}
// Backend crea automÃ¡ticamente:
// - Bolsa RECITA (especialidad: MEDICINA GENERAL)
// - Bolsa INTERCONSULTA (especialidad: CARDIOLOGÃA)
```

---

## ğŸš€ PrÃ³ximas Mejoras (Futuro)

1. **WebSocket Notifications** - Notificaciones en tiempo real en panel
2. **Adjuntos en Interconsulta** - Incluir ECG en interconsulta
3. **EvaluaciÃ³n ML** - Marcar ECG como NORMAL/ANORMAL
4. **Bulk Actions** - Atender mÃºltiples ECGs a la vez
5. **Analytics** - Dashboard de ECGs por IPRESS, por estado, por tiempo

---

## ğŸ“š Archivos Modificados

### Backend
- `V4_0_0__agregar_bolsa_teleecg.sql` - NEW
- `TeleECGService.java` - crearBolsaTeleECG(), actualizar subirImagenECG()
- `EmailService.java` - enviarNotificacionECGNuevo()
- `GestionPacienteController.java` - 3 nuevos endpoints TeleECG

### Frontend
- `IPRESSWorkspace.jsx` - Guardar todasLasImagenes
- `VisorECGModal.jsx` - (sin cambios, solo bug fix en invocation)
- `PanelECGsCoordinador.jsx` - NEW

---

## âœ… COMPLETADO

```
v1.57.1 âœ… Fix imÃ¡genes no visibles
v1.58.0 âœ… Crear bolsa automÃ¡tica
v1.58.1 âœ… Endpoints coordinadores
v1.58.2 âœ… Notificaciones email
v1.59.0 âœ… Panel frontend
v1.60.0 âœ… Enriquecimiento datos + Sync Bolsa 107

TOTAL: 6 versiones, flujo end-to-end 100% funcional
```

**Cambios v1.60.0:**
- âœ… Bolsas TeleECG siempre tienen tipo_cita = "Voluntaria"
- âœ… Bolsas Bolsa 107 siempre tienen tipo_cita = "Voluntaria"
- âœ… TelÃ©fono sincronizado desde Bolsa 107 â†’ asegurados
- âœ… TeleECG usa telÃ©fono mÃ¡s actualizado automÃ¡ticamente
- âœ… Sin intervenciÃ³n manual, totalmente automatizado

**Â¡Sistema listo para producciÃ³n! ğŸš€** Todo sincronizado automÃ¡ticamente.
