-- ============================================================================
-- üìã SCRIPT: Agregar UNIQUE Constraint a Tabla form_diag_formulario
-- ============================================================================
--
-- Fecha:       2026-01-26
-- Versi√≥n:     v1.36.0
-- Prop√≥sito:   Prevenir duplicaci√≥n de formularios EN_PROCESO por IPRESS y a√±o
-- Base Datos:  maestro_cenate
-- Tabla:       form_diag_formulario
--
-- ============================================================================

-- üîí Crear UNIQUE index parcial a nivel de base de datos
-- Garantiza que NO pueden existir 2 formularios EN_PROCESO para la misma IPRESS
-- en el mismo a√±o (solo aplica a registros con estado = 'EN_PROCESO')

CREATE UNIQUE INDEX idx_uq_formulario_en_proceso_por_ipress_anio
ON form_diag_formulario (id_ipress, anio)
WHERE estado = 'EN_PROCESO';

-- ============================================================================
-- üìù EXPLICACI√ìN DEL CONSTRAINT
-- ============================================================================
--
-- ¬øQU√â HACE?
-- -----------
-- Crea una restricci√≥n √öNICA que aplica SOLO a registros con estado = 'EN_PROCESO'
--
-- Imposible crear:
--   ‚ùå Dos formularios EN_PROCESO para IPRESS=068 a√±o=2026
--   ‚ùå Dos formularios EN_PROCESO para IPRESS=071 a√±o=2026
--   ‚ùå etc.
--
-- PERO permite:
--   ‚úÖ M√∫ltiples formularios ENVIADO, APROBADO, RECHAZADO (otros estados)
--   ‚úÖ M√∫ltiples formularios EN_PROCESO para a√±os diferentes
--   ‚úÖ M√∫ltiples formularios EN_PROCESO para IPRESS diferentes
--
-- ¬øPOR QU√â ESTA SINTAXIS?
-- ----------------------
-- CREATE UNIQUE INDEX con cl√°usula WHERE crea un "Partial Unique Index"
-- En PostgreSQL, esto es m√°s eficiente que CONSTRAINT para casos espec√≠ficos:
--   - Solo restringe las filas donde estado = 'EN_PROCESO'
--   - Las dem√°s filas (otros estados) NO est√°n sujetas a esta restricci√≥n
--   - Ocupan menos espacio en √≠ndice (solo almacena filas EN_PROCESO)
--
-- ¬øPOR QU√â IMPLEMENTARLO?
-- -----------------------
-- 1. Protecci√≥n a nivel de BD (no depende del c√≥digo Java)
-- 2. Imposible burlar aunque haya bugs en el backend
-- 3. Race conditions imposibles incluso con servers paralelos
-- 4. Complementa la validaci√≥n de FormDiagServiceImpl.guardarBorrador()
--
-- ============================================================================
-- üß™ TESTING
-- ============================================================================
--
-- Para verificar que funciona:
--
-- 1. Crear primer formulario:
--    INSERT INTO form_diag_formulario (id_ipress, anio, estado, ...)
--    VALUES (68, 2026, 'EN_PROCESO', ...)
--    ‚úÖ Resultado: OK (se inserta)
--
-- 2. Intentar crear duplicado:
--    INSERT INTO form_diag_formulario (id_ipress, anio, estado, ...)
--    VALUES (68, 2026, 'EN_PROCESO', ...)
--    ‚ùå Resultado: ERROR - duplicate key value violates unique index
--           "idx_uq_formulario_en_proceso_por_ipress_anio"
--
-- 3. Crear con estado diferente (OK):
--    INSERT INTO form_diag_formulario (id_ipress, anio, estado, ...)
--    VALUES (68, 2026, 'ENVIADO', ...)
--    ‚úÖ Resultado: OK (allowed - estado ‚â† EN_PROCESO)
--
-- ============================================================================
-- ‚úÖ ROLLBACK (si es necesario deshacer)
-- ============================================================================
--
-- DROP INDEX IF EXISTS idx_uq_formulario_en_proceso_por_ipress_anio;
--
-- ============================================================================
