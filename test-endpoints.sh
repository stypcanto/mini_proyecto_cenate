#!/bin/bash
# ========================================================================
# üîß Script de prueba completo de endpoints CENATE
# ========================================================================

set -e  # Salir si hay alg√∫n error

BASE_URL="http://localhost:8080"
echo "üåê Base URL: $BASE_URL"
echo ""

# ============================================================
# 1. Generar token de autenticaci√≥n
# ============================================================
echo "1Ô∏è‚É£  Generando token JWT..."
JWT_TOKEN=$(curl -s -X POST "$BASE_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"scantor","password":"admin123"}' | jq -r '.token')

if [ -z "$JWT_TOKEN" ] || [ "$JWT_TOKEN" == "null" ]; then
  echo "‚ùå Error: No se pudo obtener el token"
  exit 1
fi

echo "‚úÖ Token obtenido"
echo ""

# ============================================================
# 2. Health Check
# ============================================================
echo "2Ô∏è‚É£  Health Check - /api/permisos/health"
curl -s -X GET "$BASE_URL/api/permisos/health" \
  -H "Authorization: Bearer $JWT_TOKEN" | jq .
echo ""

# ============================================================
# 3. Obtener permisos por username
# ============================================================
echo "3Ô∏è‚É£  Permisos del usuario 'scantor' - /api/permisos/usuario/scantor"
PERMISOS=$(curl -s -X GET "$BASE_URL/api/permisos/usuario/scantor" \
  -H "Authorization: Bearer $JWT_TOKEN")

CANTIDAD=$(echo "$PERMISOS" | jq 'length')
echo "‚úÖ Usuario tiene $CANTIDAD permisos"
echo "$PERMISOS" | jq '.[0:3]' # Mostrar solo los primeros 3
echo ""

# ============================================================
# 4. Obtener permisos por rol
# ============================================================
echo "4Ô∏è‚É£  Permisos del rol ID 1 (SUPERADMIN) - /api/permisos/rol/1"
curl -s -X GET "$BASE_URL/api/permisos/rol/1" \
  -H "Authorization: Bearer $JWT_TOKEN" | jq .
echo ""

# ============================================================
# 5. Listar usuarios
# ============================================================
echo "5Ô∏è‚É£  Lista de usuarios - /api/usuarios"
USUARIOS=$(curl -s -X GET "$BASE_URL/api/usuarios" \
  -H "Authorization: Bearer $JWT_TOKEN")

NUM_USUARIOS=$(echo "$USUARIOS" | jq 'length')
echo "‚úÖ Total de usuarios: $NUM_USUARIOS"
echo "$USUARIOS" | jq '.[] | {username, roles}' | head -20
echo ""

# ============================================================
# Resumen
# ============================================================
echo "======================================"
echo "üèÅ Prueba completada exitosamente"
echo "======================================"
echo ""
echo "üìù Rutas disponibles:"
echo "  ‚úÖ POST   /api/auth/login"
echo "  ‚úÖ GET    /api/permisos/health"
echo "  ‚úÖ GET    /api/permisos/usuario/{username}"
echo "  ‚úÖ GET    /api/permisos/rol/{idRol}"
echo "  ‚úÖ GET    /api/usuarios"
echo "  ‚úÖ PUT    /api/permisos/{id}"
