package com.styp.cenate.api.admin;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;

import com.styp.cenate.dto.mbac.PermisoUsuarioResponseDTO;
import com.styp.cenate.model.Permiso;
import com.styp.cenate.service.permiso.PermisoService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/**
 * üéØ Controlador REST ‚Äì Gesti√≥n de permisos MBAC/RBAC en el sistema CENATE
 * ------------------------------------------------------------------------
 * Incluye:
 *  - Consultar permisos por usuario (username)
 *  - Consultar permisos por rol
 *  - Actualizar campos espec√≠ficos de permisos
 */
@RestController
@RequestMapping("/api/permisos")
@RequiredArgsConstructor
@Slf4j
@CrossOrigin(origins = {
        "http://localhost:3000",
        "http://localhost:5173",
        "http://10.0.89.13:3000",
        "http://10.0.89.13:5173"
})
@Data
public class PermisoController {

    private final PermisoService permisoService;

    // ============================================================
    // üü¢ Health check
    // ============================================================
    @GetMapping("/health")
    public ResponseEntity<Map<String, String>> health() {
        return ResponseEntity.ok(Map.of(
            "status", "UP",
            "service", "PermisoController",
            "timestamp", java.time.LocalDateTime.now().toString()
        ));
    }

    // ============================================================
    // üéØ Obtener permisos por ID de USUARIO (‚úÖ RUTA PRINCIPAL - m√°s r√°pido)
    // ============================================================
    @GetMapping("/usuario/{idUser}")
    public ResponseEntity<List<PermisoUsuarioResponseDTO>> getPermisosPorUsuarioId(
            @PathVariable Integer idUser) {
        log.info("üîé Consultando permisos del usuario ID: {}", idUser);
        List<PermisoUsuarioResponseDTO> permisos = permisoService.obtenerPermisosPorUserId(idUser);
        return ResponseEntity.ok(permisos);
    }

    // ============================================================
    // üîπ Obtener permisos por USERNAME (ruta alternativa para compatibilidad)
    // ============================================================
    @GetMapping("/usuario/username/{username}")
    public ResponseEntity<List<PermisoUsuarioResponseDTO>> getPermisosPorUsuario(
            @PathVariable String username) {
        log.info("üîé Consultando permisos del usuario '{}'", username);
        List<PermisoUsuarioResponseDTO> permisos = permisoService.obtenerPermisosPorUsername(username);
        return ResponseEntity.ok(permisos);
    }

    // ============================================================
    // üß© Obtener permisos por Rol
    // ============================================================
    @GetMapping("/rol/{idRol}")
    @PreAuthorize("hasAnyRole('SUPERADMIN', 'ADMIN')")
    public ResponseEntity<?> getPermisosByRol(@PathVariable Integer idRol) {
        log.info("üìú Solicitando permisos del rol con ID: {}", idRol);

        try {
            List<Permiso> permisos = permisoService.getPermisosByRol(idRol);

            if (permisos.isEmpty()) {
                log.warn("‚ö†Ô∏è No se encontraron permisos para el rol ID: {}", idRol);
                return ResponseEntity.ok(Map.of(
                    "message", "No se encontraron permisos para este rol",
                    "idRol", idRol,
                    "permisos", permisos
                ));
            }

            log.info("‚úÖ {} permisos encontrados para el rol ID: {}", permisos.size(), idRol);
            return ResponseEntity.ok(permisos);
        } catch (Exception e) {
            log.error("‚ùå Error al obtener permisos del rol {}: {}", idRol, e.getMessage(), e);
            return ResponseEntity.internalServerError().body(Map.of(
                "error", "Error al obtener permisos",
                "message", e.getMessage(),
                "idRol", idRol
            ));
        }
    }

    // ============================================================
    // ‚úèÔ∏è Actualizar campos espec√≠ficos de un permiso
    // ============================================================
    @PutMapping("/{id}")
    @PreAuthorize("hasAnyRole('SUPERADMIN', 'ADMIN')")
    public ResponseEntity<Permiso> updatePermiso(
            @PathVariable Long id,
            @RequestBody Map<String, Object> cambios) {

        log.info("‚úèÔ∏è Actualizando permiso ID {} con cambios: {}", id, cambios);

        try {
            Permiso actualizado = permisoService.updateCamposPermiso(id, cambios);
            log.info("‚úÖ Permiso ID {} actualizado correctamente.", id);
            return ResponseEntity.ok(actualizado);
        } catch (IllegalArgumentException e) {
            log.warn("‚ö†Ô∏è Permiso no encontrado: {}", id);
            return ResponseEntity.notFound().build();
        } catch (Exception e) {
            log.error("‚ùå Error al actualizar permiso ID {}: {}", id, e.getMessage(), e);
            return ResponseEntity.internalServerError().build();
        }
    }
}
