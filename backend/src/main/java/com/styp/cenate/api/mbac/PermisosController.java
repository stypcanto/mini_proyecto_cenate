package com.styp.cenate.api.mbac;

import com.styp.cenate.dto.mbac.*;
import com.styp.cenate.service.mbac.PermisosService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * ============================================================================
 * üéØ CONTROLADOR MBAC ‚Äì GESTI√ìN DE PERMISOS DE USUARIO
 * ----------------------------------------------------------------------------
 * Control centralizado para manejar:
 *   ‚Ä¢ Permisos de usuario (por ID o username)
 *   ‚Ä¢ Permisos por m√≥dulo y p√°gina
 *   ‚Ä¢ M√≥dulos y p√°ginas accesibles
 *   ‚Ä¢ Verificaci√≥n puntual de permisos (acciones, botones, etc.)
 *
 * Autor  : Equipo de Desarrollo CENATE
 * Versi√≥n: 2.0 (Actualizado con soporte a vistas dim_modulo / dim_pagina)
 * Fecha  : Octubre 2025
 * ============================================================================
 */
@Slf4j
@RestController
@RequiredArgsConstructor
@RequestMapping("/api/mbac/permisos")
public class PermisosController {

    private final PermisosService permisosService;

    // ============================================================
    // üîπ 1. CONSULTAR PERMISOS POR ID DE USUARIO
    // ============================================================
    @GetMapping("/usuario/{id}")
    public ResponseEntity<List<PermisoUsuarioResponseDTO>> obtenerPermisosPorUsuario(@PathVariable Long id) {
        log.info("üì• [MBAC] GET /api/mbac/permisos/usuario/{}", id);

        List<PermisoUsuarioResponseDTO> permisos = permisosService.obtenerPermisosPorUsuario(id);

        if (permisos.isEmpty()) {
            log.warn("‚ö†Ô∏è No se encontraron permisos para el usuario con ID {}", id);
        } else {
            log.info("‚úÖ Se obtuvieron {} permisos activos para el usuario ID {}", permisos.size(), id);
        }

        return ResponseEntity.ok(permisos);
    }

    // ============================================================
    // üîπ 2. CONSULTAR PERMISOS POR USERNAME
    // ============================================================
    @GetMapping("/usuario/nombre/{username}")
    public ResponseEntity<List<PermisoUsuarioResponseDTO>> obtenerPermisosPorUsername(@PathVariable String username) {
        log.info("üì• [MBAC] GET /api/mbac/permisos/usuario/nombre/{}", username);

        List<PermisoUsuarioResponseDTO> permisos = permisosService.obtenerPermisosPorUsername(username);

        if (permisos.isEmpty()) {
            log.warn("‚ö†Ô∏è No se encontraron permisos para el usuario '{}'", username);
        } else {
            log.info("‚úÖ Se obtuvieron {} permisos para el usuario '{}'", permisos.size(), username);
        }

        return ResponseEntity.ok(permisos);
    }

    // ============================================================
    // üîπ 3. CONSULTAR PERMISOS POR USUARIO Y M√ìDULO
    // ============================================================
    @GetMapping("/usuario/{userId}/modulo/{idModulo}")
    public ResponseEntity<List<PermisoUsuarioResponseDTO>> obtenerPermisosPorUsuarioYModulo(
            @PathVariable Long userId,
            @PathVariable Long idModulo) {

        log.info("üì• [MBAC] GET /api/mbac/permisos/usuario/{}/modulo/{}", userId, idModulo);

        List<PermisoUsuarioResponseDTO> permisos =
                permisosService.obtenerPermisosPorUsuarioYModulo(userId, idModulo);

        if (permisos.isEmpty()) {
            log.warn("‚ö†Ô∏è No se encontraron permisos del usuario {} para el m√≥dulo {}", userId, idModulo);
        } else {
            log.info("‚úÖ Se obtuvieron {} permisos del usuario {} para el m√≥dulo {}", permisos.size(), userId, idModulo);
        }

        return ResponseEntity.ok(permisos);
    }

    // ============================================================
    // üîπ 4. VERIFICAR PERMISO ESPEC√çFICO (para botones/acciones)
    // ============================================================
    @PostMapping("/verificar")
    public ResponseEntity<CheckPermisoResponseDTO> verificarPermiso(
            @Valid @RequestBody CheckPermisoRequestDTO request) {

        log.info("üì§ [MBAC] POST /api/mbac/permisos/verificar -> {}", request);

        CheckPermisoResponseDTO response = permisosService.verificarPermiso(request);

        log.info("üîç Resultado de verificaci√≥n: usuario={}, ruta={}, acci√≥n={}, permitido={}",
                response.getIdUser(), response.getRutaPagina(), response.getAccion(), response.getPermitido());

        return ResponseEntity.ok(response);
    }

    // ============================================================
    // üîπ 5. LISTAR M√ìDULOS ACCESIBLES POR USUARIO
    // ============================================================
    @GetMapping("/usuario/{userId}/modulos")
    public ResponseEntity<List<ModuloSistemaResponse>> obtenerModulosAccesiblesUsuario(@PathVariable Long userId) {
        log.info("üì¶ [MBAC] GET /api/mbac/permisos/usuario/{}/modulos", userId);

        List<ModuloSistemaResponse> modulos = permisosService.obtenerModulosAccesiblesUsuario(userId);

        if (modulos.isEmpty()) {
            log.warn("‚ö†Ô∏è El usuario {} no tiene m√≥dulos asignados", userId);
        } else {
            log.info("‚úÖ Se encontraron {} m√≥dulos accesibles para el usuario {}", modulos.size(), userId);
        }

        return ResponseEntity.ok(modulos);
    }

    // ============================================================
    // üîπ 6. LISTAR P√ÅGINAS ACCESIBLES DENTRO DE UN M√ìDULO
    // ============================================================
    @GetMapping("/usuario/{userId}/modulo/{idModulo}/paginas")
    public ResponseEntity<List<PaginaModuloResponse>> obtenerPaginasAccesiblesUsuario(
            @PathVariable Long userId,
            @PathVariable Long idModulo) {

        log.info("üìë [MBAC] GET /api/mbac/permisos/usuario/{}/modulo/{}/paginas", userId, idModulo);

        List<PaginaModuloResponse> paginas =
                permisosService.obtenerPaginasAccesiblesUsuario(userId, idModulo);

        if (paginas.isEmpty()) {
            log.warn("‚ö†Ô∏è No se encontraron p√°ginas accesibles para el usuario {} en m√≥dulo {}", userId, idModulo);
        } else {
            log.info("‚úÖ El usuario {} tiene acceso a {} p√°ginas del m√≥dulo {}", userId, paginas.size(), idModulo);
        }

        return ResponseEntity.ok(paginas);
    }

    // ============================================================
    // üîπ 7. VALIDAR PERMISO DE ACCI√ìN (alias r√°pido)
    // ============================================================
    @GetMapping("/check/{userId}")
    public ResponseEntity<Boolean> validarPermisoRapido(
            @PathVariable Long userId,
            @RequestParam String ruta,
            @RequestParam String accion) {

        log.info("‚öôÔ∏è [MBAC] Validando acceso r√°pido -> usuario={}, ruta={}, acci√≥n={}", userId, ruta, accion);

        boolean tienePermiso = permisosService.validarPermiso(userId, ruta, accion);

        log.info("üîê Resultado r√°pido -> {}", tienePermiso ? "PERMITIDO ‚úÖ" : "DENEGADO ‚ùå");

        return ResponseEntity.ok(tienePermiso);
    }
}