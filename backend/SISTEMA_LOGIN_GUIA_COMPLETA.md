# üîê Sistema de Login con Roles y Permisos - CENATE

## üìã √çndice
1. [Instalaci√≥n](#instalaci√≥n)
2. [Base de Datos](#base-de-datos)
3. [Credenciales del SUPERADMIN](#credenciales)
4. [API Endpoints](#api-endpoints)
5. [Ejemplos de Uso](#ejemplos-de-uso)
6. [Testing](#testing)

---

## üöÄ Instalaci√≥n

### Paso 1: Configurar Base de Datos

Ejecuta el script SQL en tu base de datos PostgreSQL:

```bash
psql -U postgres -d maestro_cenate -f backend/sql/03_sistema_login_completo.sql
```

Este script:
- ‚úÖ Crea las tablas necesarias (si no existen)
- ‚úÖ Crea roles: SUPERADMIN, ADMIN, ESPECIALISTA, RADIOLOGO, USUARIO
- ‚úÖ Crea 18 permisos del sistema
- ‚úÖ Asigna permisos a cada rol
- ‚úÖ Crea el usuario SUPERADMIN con contrase√±a encriptada
- ‚úÖ Crea √≠ndices para optimizaci√≥n

### Paso 2: Verificar application.properties

Aseg√∫rate de que `backend/src/main/resources/application.properties` tenga la configuraci√≥n correcta:

```properties
# Base de Datos
spring.datasource.url=jdbc:postgresql://10.0.89.13:5432/maestro_cenate
spring.datasource.username=postgres
spring.datasource.password=Essalud2025

# JWT (Opcional - usa los valores por defecto)
jwt.secret.key=404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970
jwt.expiration=86400000
```

### Paso 3: Compilar y Ejecutar

```bash
cd backend
./mvnw clean package
./mvnw spring-boot:run
```

O si usas Gradle:

```bash
./gradlew clean build
./gradlew bootRun
```

---

## üóÑÔ∏è Base de Datos

### Estructura de Tablas

```
DIM_USUARIOS
‚îú‚îÄ‚îÄ id_user (PK)
‚îú‚îÄ‚îÄ name_user (username - UNIQUE)
‚îú‚îÄ‚îÄ pass_user (password encriptada)
‚îú‚îÄ‚îÄ stat_user (ACTIVO/INACTIVO/BLOQUEADO)
‚îú‚îÄ‚îÄ create_at, update_at
‚îú‚îÄ‚îÄ password_changed_at
‚îú‚îÄ‚îÄ failed_attempts
‚îú‚îÄ‚îÄ locked_until
‚îú‚îÄ‚îÄ last_login_at
‚îî‚îÄ‚îÄ reset_token_hash, reset_token_expires_at

DIM_ROLES
‚îú‚îÄ‚îÄ id_rol (PK)
‚îú‚îÄ‚îÄ desc_rol (nombre del rol)
‚îú‚îÄ‚îÄ created_at, updated_at

USUARIOS_ROLES (Many-to-Many)
‚îú‚îÄ‚îÄ id_user (FK)
‚îú‚îÄ‚îÄ id_rol (FK)
‚îî‚îÄ‚îÄ asig_en (timestamp)

DIM_PERMISOS
‚îú‚îÄ‚îÄ id_permiso (PK)
‚îú‚îÄ‚îÄ desc_permiso (nombre del permiso)
‚îú‚îÄ‚îÄ created_at, updated_at

ROLES_PERMISOS (Many-to-Many)
‚îú‚îÄ‚îÄ id_rol (FK)
‚îú‚îÄ‚îÄ id_permiso (FK)
‚îî‚îÄ‚îÄ asig_en (timestamp)
```

### Roles y Permisos

#### SUPERADMIN
- ‚úÖ **Todos los permisos** (18 permisos)
- Control total del sistema

#### ADMIN
- ‚úÖ Gestionar usuarios, roles y permisos
- ‚úÖ Acceso a todas las aplicaciones
- ‚úÖ Generar reportes
- ‚ùå NO puede gestionar SUPERADMINs

#### ESPECIALISTA
- ‚úÖ Acceso a apps de especialidades
- ‚úÖ Gesti√≥n de citas
- ‚úÖ Ver reportes

#### RADIOLOGO
- ‚úÖ Acceso a app de radiolog√≠a
- ‚úÖ Ver reportes

#### USUARIO
- ‚úÖ Acceso b√°sico a especialidades
- ‚úÖ Ver reportes

---

## üîë Credenciales del SUPERADMIN

```
Username: superadmin
Password: SuperAdmin2024!
```

**‚ö†Ô∏è IMPORTANTE:** Cambiar esta contrase√±a despu√©s del primer login.

---

## üì° API Endpoints

### Autenticaci√≥n (P√∫blicos)

#### 1. Login
```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "superadmin",
  "password": "SuperAdmin2024!"
}
```

**Respuesta Exitosa (200 OK):**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "type": "Bearer",
  "userId": 1,
  "username": "superadmin",
  "roles": ["SUPERADMIN"],
  "permisos": [
    "GESTIONAR_SUPERADMINS",
    "GESTIONAR_ADMINS",
    "GESTIONAR_USUARIOS",
    "VER_USUARIOS",
    ...
  ],
  "message": "Login exitoso"
}
```

**Respuesta Error (401 Unauthorized):**
```json
{
  "message": "Usuario o contrase√±a incorrectos"
}
```

#### 2. Registrar Usuario
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "nuevo_usuario",
  "password": "Password123!",
  "roleIds": [2],
  "estado": "ACTIVO"
}
```

#### 3. Health Check
```http
GET /api/auth/health
```

### Gesti√≥n de Usuarios (Protegidos - Requieren JWT)

Todos los endpoints requieren el header:
```
Authorization: Bearer {token}
```

#### 1. Obtener Todos los Usuarios
```http
GET /api/usuarios
Authorization: Bearer {token}
```
**Roles permitidos:** SUPERADMIN, ADMIN

#### 2. Obtener Usuario por ID
```http
GET /api/usuarios/{id}
Authorization: Bearer {token}
```
**Roles permitidos:** SUPERADMIN, ADMIN

#### 3. Obtener Usuario Actual
```http
GET /api/usuarios/me
Authorization: Bearer {token}
```
**Roles permitidos:** Cualquier usuario autenticado

#### 4. Activar Usuario
```http
PUT /api/usuarios/{id}/activate
Authorization: Bearer {token}
```
**Roles permitidos:** SUPERADMIN, ADMIN

#### 5. Desactivar Usuario
```http
PUT /api/usuarios/{id}/deactivate
Authorization: Bearer {token}
```
**Roles permitidos:** SUPERADMIN, ADMIN

#### 6. Desbloquear Usuario
```http
PUT /api/usuarios/{id}/unlock
Authorization: Bearer {token}
```
**Roles permitidos:** SUPERADMIN, ADMIN

#### 7. Eliminar Usuario
```http
DELETE /api/usuarios/{id}
Authorization: Bearer {token}
```
**Roles permitidos:** Solo SUPERADMIN

---

## üí° Ejemplos de Uso

### Ejemplo 1: Login con cURL

```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "superadmin",
    "password": "SuperAdmin2024!"
  }'
```

### Ejemplo 2: Obtener Usuario Actual con cURL

```bash
TOKEN="tu_token_jwt_aqui"

curl -X GET http://localhost:8080/api/usuarios/me \
  -H "Authorization: Bearer $TOKEN"
```

### Ejemplo 3: Crear Usuario con Postman

1. Method: POST
2. URL: `http://localhost:8080/api/auth/register`
3. Headers:
   - Content-Type: application/json
4. Body (raw JSON):
```json
{
  "username": "doctor_perez",
  "password": "Doctor2024!",
  "roleIds": [3],
  "estado": "ACTIVO"
}
```

### Ejemplo 4: Uso en Frontend (JavaScript/React)

```javascript
// Login
async function login(username, password) {
  const response = await fetch('http://localhost:8080/api/auth/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ username, password }),
  });

  if (response.ok) {
    const data = await response.json();
    localStorage.setItem('token', data.token);
    localStorage.setItem('user', JSON.stringify({
      userId: data.userId,
      username: data.username,
      roles: data.roles,
      permisos: data.permisos
    }));
    return data;
  } else {
    throw new Error('Login fallido');
  }
}

// Obtener usuario actual
async function getCurrentUser() {
  const token = localStorage.getItem('token');
  
  const response = await fetch('http://localhost:8080/api/usuarios/me', {
    headers: {
      'Authorization': `Bearer ${token}`,
    },
  });

  if (response.ok) {
    return await response.json();
  }
}

// Verificar si tiene permiso
function hasPermission(permission) {
  const user = JSON.parse(localStorage.getItem('user'));
  return user?.permisos?.includes(permission) || false;
}

// Uso
if (hasPermission('GESTIONAR_USUARIOS')) {
  // Mostrar interfaz de gesti√≥n de usuarios
}
```

---

## üß™ Testing

### Probar con Postman

1. **Importar colecci√≥n:** Crea una nueva colecci√≥n en Postman
2. **Crear ambiente:** 
   - Variable: `baseUrl` = `http://localhost:8080`
   - Variable: `token` = (se llenar√° autom√°ticamente)

3. **Tests automatizados:**

**Login (guardar token):**
```javascript
// En la pesta√±a "Tests" del request de login
pm.test("Login successful", function () {
    pm.response.to.have.status(200);
    var jsonData = pm.response.json();
    pm.environment.set("token", jsonData.token);
});
```

### Probar Seguridad

#### Test 1: Login con credenciales incorrectas
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "superadmin",
    "password": "contrase√±a_incorrecta"
  }'
```
**Esperado:** 401 Unauthorized

#### Test 2: Acceso sin token
```bash
curl -X GET http://localhost:8080/api/usuarios
```
**Esperado:** 401 Unauthorized o 403 Forbidden

#### Test 3: Bloqueo por intentos fallidos
Hacer 5 intentos con contrase√±a incorrecta:
```bash
for i in {1..5}; do
  curl -X POST http://localhost:8080/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"username": "superadmin", "password": "wrong"}'
  echo "\nIntento $i"
done
```
**Esperado:** En el 5to intento, el usuario debe ser bloqueado por 30 minutos

### Probar Roles

#### Test 1: SUPERADMIN puede eliminar usuarios
```bash
TOKEN="token_del_superadmin"
curl -X DELETE http://localhost:8080/api/usuarios/2 \
  -H "Authorization: Bearer $TOKEN"
```
**Esperado:** 200 OK

#### Test 2: ADMIN NO puede eliminar usuarios
```bash
TOKEN="token_del_admin"
curl -X DELETE http://localhost:8080/api/usuarios/2 \
  -H "Authorization: Bearer $TOKEN"
```
**Esperado:** 403 Forbidden

---

## üîß Troubleshooting

### Problema 1: Error de conexi√≥n a la base de datos
```
Error: Unable to connect to database
```
**Soluci√≥n:**
1. Verificar que PostgreSQL est√© corriendo
2. Verificar credenciales en `application.properties`
3. Verificar que la base de datos `maestro_cenate` exista

### Problema 2: Token expirado
```json
{
  "message": "Token expired"
}
```
**Soluci√≥n:** Hacer login nuevamente para obtener un nuevo token

### Problema 3: Usuario bloqueado
```json
{
  "message": "Cuenta bloqueada por m√∫ltiples intentos fallidos"
}
```
**Soluci√≥n:** 
- Esperar 30 minutos
- O desbloquear manualmente: `PUT /api/usuarios/{id}/unlock`

---

## üìö Recursos Adicionales

### Generar Contrase√±as BCrypt

Puedes usar este c√≥digo Java para generar nuevas contrase√±as:

```java
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

public class PasswordGenerator {
    public static void main(String[] args) {
        BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
        String rawPassword = "MiNuevaContrase√±a123!";
        String encodedPassword = encoder.encode(rawPassword);
        System.out.println("Password encriptada: " + encodedPassword);
    }
}
```

O usa una herramienta online (cuidado con contrase√±as en producci√≥n):
- https://bcrypt-generator.com/

### Queries SQL √ötiles

```sql
-- Ver todos los usuarios con sus roles
SELECT 
    u.id_user,
    u.name_user,
    u.stat_user,
    STRING_AGG(r.desc_rol, ', ') as roles
FROM dim_usuarios u
LEFT JOIN usuarios_roles ur ON u.id_user = ur.id_user
LEFT JOIN dim_roles r ON ur.id_rol = r.id_rol
GROUP BY u.id_user, u.name_user, u.stat_user;

-- Ver permisos de un usuario
SELECT DISTINCT
    u.name_user,
    p.desc_permiso
FROM dim_usuarios u
JOIN usuarios_roles ur ON u.id_user = ur.id_user
JOIN dim_roles r ON ur.id_rol = r.id_rol
JOIN roles_permisos rp ON r.id_rol = rp.id_rol
JOIN dim_permisos p ON rp.id_permiso = p.id_permiso
WHERE u.name_user = 'superadmin';

-- Resetear intentos fallidos manualmente
UPDATE dim_usuarios
SET failed_attempts = 0, locked_until = NULL
WHERE name_user = 'superadmin';
```

---

## üéØ Pr√≥ximos Pasos

1. ‚úÖ Sistema de login funcionando
2. ‚úÖ Gesti√≥n de roles y permisos
3. ‚úÖ Bloqueo por intentos fallidos
4. üîÑ Implementar cambio de contrase√±a
5. üîÑ Implementar recuperaci√≥n de contrase√±a
6. üîÑ Implementar auditor√≠a de acciones
7. üîÑ Implementar sesiones m√∫ltiples
8. üîÑ Panel de administraci√≥n en frontend

---

## üë®‚Äçüíª Soporte

Para soporte o reportar issues:
1. Revisar logs del backend
2. Verificar la base de datos
3. Consultar esta documentaci√≥n

**Logs √∫tiles:**
- Backend logs: consola donde corre Spring Boot
- Base de datos: `SELECT * FROM dim_usuarios WHERE name_user = 'usuario';`

---

**Fecha:** 08/10/2025  
**Versi√≥n:** 1.0.0  
**Sistema:** CENATE - Centro Nacional de Telemedicina
