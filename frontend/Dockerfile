# ========================================================================
# ğŸ§© FRONTEND - CENATE (React CRA + Nginx)
# ------------------------------------------------------------------------
# â€¢ Build de React con Node 18
# â€¢ Servidor Nginx optimizado para producciÃ³n
# â€¢ Soluciona:
#    - ImÃ¡genes que no se mostraban (alias + permisos)
#    - Proxy correcto al backend
#    - Compatibilidad ARM64 (Mac M1/M2)
# ========================================================================

# ================================
# âš™ï¸ Etapa 1 - Build de React App
# ================================
FROM node:20-alpine AS build

WORKDIR /app

# Copiar dependencias primero (mejor cachÃ©)
COPY package*.json ./

# Limpiar cache de npm
RUN npm cache clean --force

# Instalar dependencias principales (incluyendo react-is)
RUN npm install --legacy-peer-deps

# Instalar versiones compatibles de ajv y ajv-keywords (por CRA)
RUN npm install ajv@6 ajv-keywords@3 --save-dev --legacy-peer-deps

# Asegurar que react-is estÃ© instalado (requerido por recharts)
RUN npm install react-is --legacy-peer-deps || true

# Copiar el resto del cÃ³digo fuente
COPY . .

# âœ… Asegurar entorno de producciÃ³n para build
ENV NODE_ENV=production

# ğŸ”‘ CRITICAL: Configurar variable de entorno para el build
# Esto hace que React use /api (proxy de nginx) en lugar de http://localhost:8080/api
ENV REACT_APP_API_URL=/api
ENV REACT_APP_ENV=production

# ğŸ”¨ Compilar la aplicaciÃ³n React para producciÃ³n
RUN npm run build

# ================================
# ğŸš€ Etapa 2 - Servidor Nginx
# ================================
FROM nginx:alpine

# ğŸ§¹ Eliminar configuraciÃ³n por defecto
RUN rm -rf /etc/nginx/conf.d/*

# ğŸ“¦ Copiar build generado por React
COPY --from=build /app/build /usr/share/nginx/html

# ğŸ–¼ï¸ Copiar las imÃ¡genes del directorio public/images manualmente
RUN mkdir -p /usr/share/nginx/html/images
COPY ./public/images/. /usr/share/nginx/html/images/

# âœ… Dar permisos de lectura a las imÃ¡genes (evita errores 403)
RUN chmod -R 755 /usr/share/nginx/html/images

# âš™ï¸ Copiar configuraciÃ³n personalizada de Nginx
COPY nginx.conf /etc/nginx/conf.d/default.conf

# ğŸŒ Variables de entorno
ENV TZ=America/Lima
ENV NODE_ENV=production

# ğŸ”¥ Limpieza y diagnÃ³stico opcional
RUN rm -rf /var/cache/apk/* /tmp/*

# Exponer puerto
EXPOSE 80

# ğŸš€ Iniciar Nginx en primer plano
CMD ["nginx", "-g", "daemon off;"]