# üìã Panel de Gesti√≥n de Personal - CENATE

## üéØ Descripci√≥n General

Sistema profesional de gesti√≥n de personal con dise√±o Apple-like, que integra personal interno (CENATE) y externo con control de acceso basado en m√≥dulos (MBAC - Modular-Based Access Control).

---

## ‚ú® Caracter√≠sticas Principales

### üé® Dise√±o y UX
- **Dise√±o Apple-like**: Interfaz minimalista inspirada en macOS y iCloud Dashboard
- **Animaciones fluidas**: Transiciones suaves con Framer Motion
- **Responsive**: Optimizado para desktop, tablet y m√≥vil
- **Glassmorphism**: Efectos de vidrio y blur para un aspecto moderno
- **Feedback visual**: Hover states, scaling y sombras din√°micas

### üë• Gesti√≥n de Personal
- **Vista unificada**: Personal CENATE y Externo en una sola tabla
- **B√∫squeda inteligente**: Por nombre, documento o username
- **Filtros m√∫ltiples**: Por tipo de personal, rol y estado
- **Estad√≠sticas en tiempo real**: Cards con contadores din√°micos
- **Export a CSV**: Exportaci√≥n de datos con encoding UTF-8

### üîí Seguridad MBAC
- **Control de permisos**: Ver, crear, editar, eliminar, exportar
- **Validaci√≥n por ruta**: Permisos granulares por p√°gina del sistema
- **Integraci√≥n con roles**: SUPERADMIN tiene acceso completo
- **Protecci√≥n de datos**: Solo muestra informaci√≥n seg√∫n permisos del usuario

### üìä Detalle de Personal
- **Card modal animado**: Vista completa de informaci√≥n del personal
- **Estructura adaptativa**: Diferencia autom√°tica entre CENATE y Externo
- **Informaci√≥n completa**: Datos personales, contacto, laborales y de usuario
- **Fotos de perfil**: Soporte para im√°genes del personal CENATE
- **Badges visuales**: Roles, especialidades y estados claramente identificados

---

## üìÅ Estructura de Archivos

```
frontend/src/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ personal.js                 # ‚úÖ ACTUALIZADO - API endpoints con funci√≥n unificada
‚îÇ   ‚îî‚îÄ‚îÄ permisosApi.js             # Sistema MBAC para permisos
‚îú‚îÄ‚îÄ components/ui/
‚îÇ   ‚îî‚îÄ‚îÄ PersonalDetailCard.jsx     # ‚úÖ ACTUALIZADO - Card de detalle mejorado
‚îú‚îÄ‚îÄ pages/admin/
‚îÇ   ‚îî‚îÄ‚îÄ AdminPersonalPanel.jsx     # ‚úÖ ACTUALIZADO - Panel principal corregido
‚îî‚îÄ‚îÄ hooks/
    ‚îî‚îÄ‚îÄ useAuth.js                  # Hook de autenticaci√≥n
```

---

## üîß Cambios Realizados

### 1. **personal.js** - API de Personal
#### ‚úÖ Correcciones:
- **Funci√≥n unificada**: `getDetallePersonal(idUser)` reemplaza `getDetalleCenate` y `getDetalleExterno`
- **Endpoint correcto**: Usa `/api/personal/detalle/{idUser}` que determina el tipo autom√°ticamente
- **Nuevas funciones**: Agregado soporte para cumplea√±os (hoy, mes actual, mes espec√≠fico)

```javascript
// ‚ùå ANTES (incorrecto):
export const getDetalleCenate = (id) =>
    safeFetch(`${API_BASE}/personal/cenate/${id}`, ...);
export const getDetalleExterno = (id) =>
    safeFetch(`${API_BASE}/personal/externo/${id}`, ...);

// ‚úÖ AHORA (correcto):
export const getDetallePersonal = (idUser) =>
    safeFetch(`${API_BASE}/personal/detalle/${idUser}`, ...);
```

### 2. **AdminPersonalPanel.jsx** - Panel Principal
#### ‚úÖ Correcciones:
- **ID correcto**: Usa `persona.id_user` en lugar de `persona.id_personal`
- **Estado actualizado**: Compara con `'ACTIVO'` en lugar de `'A'`
- **Funci√≥n API correcta**: Llama a `getDetallePersonal(persona.id_user)`
- **Mejor manejo de errores**: Mensajes m√°s descriptivos y opci√≥n de reintentar
- **Export mejorado**: CSV con encoding UTF-8 y escape de comillas

```javascript
// ‚ùå ANTES (incorrecto):
const handleVerDetalle = async (persona) => {
  let detalle;
  if (persona.tipo_personal === 'CENATE') {
    detalle = await getDetalleCenate(persona.id_personal); // ‚ùå id_personal no existe
  } else {
    detalle = await getDetalleExterno(persona.id_personal);
  }
};

// ‚úÖ AHORA (correcto):
const handleVerDetalle = async (persona) => {
  const detalle = await getDetallePersonal(persona.id_user); // ‚úÖ usa id_user correcto
  setSelectedPersonal(detalle);
  setShowDetail(true);
};
```

### 3. **PersonalDetailCard.jsx** - Card de Detalle
#### ‚úÖ Correcciones:
- **Estructura de datos anidada**: Accede correctamente a `personal.personal.*`
- **Detecci√≥n de tipo**: `isCenate` basado en presencia de `data.laboral.area`
- **Campos condicionales**: Muestra especialidades, colegiatura, etc. solo para CENATE
- **Formateo mejorado**: Cumplea√±os con mes en espa√±ol, edad actual
- **Validaci√≥n de datos**: No muestra campos vac√≠os o null

```javascript
// ‚úÖ Estructura correcta del JSON del backend:
{
  "id_user": 1,
  "username": "scantor",
  "estado_usuario": "ACTIVO",
  "roles": ["SUPERADMIN"],
  "personal": {
    "nombre_completo": "STYP CANTO RONDON",
    "contacto": {
      "correo_corporativo": "...",
      "telefono": "..."
    },
    "laboral": {
      "area": "GESTI√ìN TI",
      "especialidades": ["CARDIOLOGIA"]
    }
  }
}

// ‚úÖ Acceso correcto en el componente:
const data = personal.personal;
const isCenate = data.laboral?.area !== undefined;
<Campo value={data.nombre_completo} />
<Campo value={data.contacto.telefono} />
```

---

## üöÄ C√≥mo Usar

### 1. **Acceso al Panel**
- **Ruta**: `/admin/personal`
- **Permisos requeridos**: Usuario debe tener permiso `ver` en ruta `/roles/admin/personal` o rol `SUPERADMIN`

### 2. **B√∫squeda y Filtros**
- **B√∫squeda**: Escribe nombre, documento o username
- **Filtro por tipo**: TODOS, CENATE, EXTERNO
- **Filtro por rol**: Lista din√°mica de roles disponibles
- **Filtro por estado**: TODOS, ACTIVO, INACTIVO

### 3. **Ver Detalle**
- Click en bot√≥n "Ver Detalle" de cualquier registro
- Se abre modal con informaci√≥n completa
- Dise√±o adaptativo seg√∫n tipo de personal (CENATE/EXTERNO)

### 4. **Exportar Datos**
- Click en bot√≥n "Exportar" (solo si tienes permiso `exportar`)
- Genera archivo CSV con encoding UTF-8
- Incluye todos los registros filtrados actualmente

---

## üîå Endpoints del Backend

### Personal Total
```
GET /api/personal/total
```
Retorna lista de todo el personal (CENATE + Externo)

### Detalle de Personal
```
GET /api/personal/detalle/{idUser}
```
Retorna detalle completo del usuario (determina tipo autom√°ticamente)

**Respuesta:**
```json
{
  "id_user": 1,
  "username": "scantor",
  "estado_usuario": "ACTIVO",
  "roles": ["SUPERADMIN"],
  "personal": {
    "id_personal": 1,
    "nombre_completo": "STYP CANTO RONDON",
    "tipo_documento": "DNI",
    "numero_documento": "44914706",
    "genero": "M",
    "fecha_nacimiento": "1988-02-25",
    "edad_actual": 37,
    "cumpleanos": { "mes": "February", "dia": 25 },
    "foto": "personal_1_xxx.png",
    "contacto": {
      "correo_corporativo": "...",
      "correo_personal": "...",
      "telefono": "..."
    },
    "direccion": {
      "domicilio": "...",
      "distrito": "MIRAFLORES",
      "provincia": "LIMA",
      "departamento": "LIMA"
    },
    "ipress": "CENTRO NACIONAL DE TELEMEDICINA",
    "laboral": {          // Solo CENATE
      "area": "GESTI√ìN TI",
      "profesion": "MEDICO",
      "regimen_laboral": "LOCADOR",
      "codigo_planilla": "s/n",
      "numero_colegiatura": "13178",
      "rne_especialista": "14257",
      "especialidades": ["CARDIOLOGIA"]
    }
  },
  "fechas": {
    "fecha_registro": "2025-10-08T21:06:13...",
    "ultima_actualizacion": "2025-10-15T12:00:27..."
  }
}
```

### Cumplea√±os
```
GET /api/personal/cumpleaneros/hoy        # Hoy
GET /api/personal/cumpleaneros/mes        # Mes actual
GET /api/personal/cumpleaneros/mes/{mes}  # Mes espec√≠fico (1-12)
```

---

## üé® Componentes de UI

### EstadoBadge
Badge que muestra el estado del usuario con colores:
- **Verde**: ACTIVO
- **Gris**: INACTIVO

### TipoBadge
Badge que identifica el tipo de personal:
- **√çndigo**: CENATE
- **P√∫rpura**: EXTERNO

### Campo (PersonalDetailCard)
Componente reutilizable para mostrar informaci√≥n con √≠cono:
```jsx
<Campo 
  icon={Mail} 
  label="Correo" 
  value="email@example.com" 
  highlight={true} 
/>
```

---

## ‚öôÔ∏è Variables de Entorno

```env
REACT_APP_API_URL=http://localhost:8080/api
```

---

## üêõ Troubleshooting

### Problema: "No se pudo cargar el detalle del personal"
**Causa**: El usuario no tiene datos de personal asociados en la BD  
**Soluci√≥n**: Verificar que `id_user` tenga registro en `dim_personal_cnt` o `dim_personal_externo`

### Problema: "Acceso Denegado"
**Causa**: Usuario no tiene permisos MBAC  
**Soluci√≥n**: Asignar permiso `ver` en `/roles/admin/personal` o rol `SUPERADMIN`

### Problema: Foto no se muestra
**Causa**: Archivo de foto no existe o ruta incorrecta  
**Soluci√≥n**: Verificar que la foto est√© en la carpeta correcta del backend

### Problema: Export CSV con caracteres raros
**Causa**: Encoding incorrecto  
**Soluci√≥n**: El c√≥digo ya incluye BOM UTF-8 (`'\uFEFF' + csv`)

---

## üìä Estructura MBAC

### Rutas de Permisos
```
/roles/admin/personal
```

### Permisos Disponibles
- `ver`: Ver lista y detalles
- `crear`: Crear nuevo personal (pr√≥ximamente)
- `editar`: Modificar personal (pr√≥ximamente)
- `eliminar`: Eliminar personal (pr√≥ximamente)
- `exportar`: Exportar a CSV

### Roles con Acceso Completo
- `SUPERADMIN`: Acceso total sin restricciones

---

## üîÆ Pr√≥ximas Mejoras

- [ ] Crear/Editar personal desde el panel
- [ ] Subir/Actualizar fotos de perfil
- [ ] Historial de cambios (auditor√≠a)
- [ ] Filtros avanzados (fecha de ingreso, departamento)
- [ ] Exportar a Excel/PDF
- [ ] Vista de cumplea√±os del mes
- [ ] Integraci√≥n con chat interno
- [ ] Notificaciones push

---

## üë®‚Äçüíª Desarrollado por

**CENATE Development Team**  
Sistema de Telemedicina - ESSALUD

---

## üìÑ Licencia

Uso interno - CENATE ¬© 2025
