// src/config/api.js
// ========================================================================
// üåç CONFIGURACI√ìN GLOBAL DEL CLIENTE API - CENATE
// ========================================================================

// ‚úÖ Detecta entorno y usa la URL correcta
const getApiBaseUrl = () => {
  // Si est√°s en producci√≥n con Vite o CRA (React)
  const envUrl =
      import.meta?.env?.VITE_API_URL || process.env.REACT_APP_API_URL;

  // Fallback por defecto (√∫til para desarrollo local)
  return envUrl || "http://localhost:8080/api";
};

export const API_BASE = getApiBaseUrl();

/**
 * üîß Genera encabezados HTTP para las solicitudes
 * @param {boolean} includeAuth - Si debe incluir el token JWT
 */
export const getHeaders = (includeAuth = false) => {
  const headers = {
    "Content-Type": "application/json",
  };

  if (includeAuth) {
    const token = localStorage.getItem("token");
    if (token) headers["Authorization"] = `Bearer ${token}`;
  }

  return headers;
};

/**
 * ‚öôÔ∏è Maneja las respuestas del servidor y lanza errores si es necesario
 * @param {Response} response
 */
export const handleResponse = async (response) => {
  let data;

  try {
    data = await response.json();
  } catch {
    data = { message: "Respuesta no v√°lida del servidor" };
  }

  if (!response.ok) {
    // üí• Maneja casos comunes
    const errorMessage =
        data?.message ||
        (response.status === 401
            ? "Sesi√≥n expirada o no autorizada."
            : response.status === 403
                ? "No tienes permisos para esta acci√≥n."
                : `Error ${response.status}`);
    throw new Error(errorMessage);
  }

  return data;
};

/**
 * üöÄ M√©todo de ayuda para realizar peticiones gen√©ricas
 * @param {string} endpoint - Endpoint relativo (por ejemplo, "/auth/login")
 * @param {string} method - M√©todo HTTP (GET, POST, PUT, DELETE)
 * @param {Object} [body] - Cuerpo de la solicitud
 * @param {boolean} [includeAuth] - Si incluye el token JWT
 */
export const apiRequest = async (endpoint, method = "GET", body, includeAuth = false) => {
  const options = {
    method,
    headers: getHeaders(includeAuth),
  };

  if (body) options.body = JSON.stringify(body);

  try {
    const response = await fetch(`${API_BASE}${endpoint}`, options);
    return await handleResponse(response);
  } catch (error) {
    console.error("‚ùå Error de red o conexi√≥n con el servidor:", error);
    throw new Error("No se pudo conectar con el servidor. Verifica la red o el backend.");
  }
};