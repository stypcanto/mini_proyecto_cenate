// ========================================================================
// üåç CONFIGURACI√ìN GLOBAL DEL CLIENTE API - CENATE
// ========================================================================

// ‚úÖ Detecta entorno y usa la URL correcta (compatible con CRA y Vite)
const getApiBaseUrl = () => {
  // Intenta obtener desde variables de entorno
  const envUrl =
    import.meta?.env?.VITE_API_URL || process.env.REACT_APP_API_URL;

  // Si existe, limpia posibles barras finales
  if (envUrl) {
    const base = envUrl.trim().replace(/\/$/, "");
    return base;
  }

  // üåê Si no hay variable de entorno, decide seg√∫n entorno:
  // - En desarrollo local (CRA con npm start) ‚Üí usa backend en localhost:8080
  // - En Docker/Nginx o producci√≥n ‚Üí usa proxy interno /api
  const isLocalDev =
    typeof window !== "undefined" && window.location.port !== "80";
  return isLocalDev ? "http://localhost:8080/api" : "/api";
};

// üåê Base de la API
export const API_BASE = getApiBaseUrl();

// ========================================================================
// üß± HEADERS GENERALES
// ========================================================================
export const getHeaders = (includeAuth = false) => {
  const headers = {
    "Content-Type": "application/json",
    Accept: "application/json",
  };

  if (includeAuth) {
    const token = localStorage.getItem("token");
    if (token) headers.Authorization = `Bearer ${token}`;
  }

  return headers;
};

// ========================================================================
// ‚öôÔ∏è MANEJO DE RESPUESTAS
// ========================================================================
export const handleResponse = async (response) => {
  let data;

  try {
    data = await response.json();
  } catch {
    data = { message: "Respuesta no v√°lida del servidor." };
  }

  if (!response.ok) {
    const errorMessage =
      data?.message ||
      (response.status === 401
        ? "‚ö†Ô∏è Sesi√≥n expirada o no autorizada."
        : response.status === 403
        ? "üö´ No tienes permisos para esta acci√≥n."
        : `Error ${response.status}: ${response.statusText}`);

    console.error("‚ùå Error de API:", errorMessage, data);
    throw new Error(errorMessage);
  }

  return data;
};

// ========================================================================
// üöÄ PETICI√ìN GEN√âRICA (helper universal)
// ========================================================================
export const apiRequest = async (
  endpoint,
  method = "GET",
  body = null,
  includeAuth = false
) => {
  const url = `${API_BASE}${
    endpoint.startsWith("/") ? endpoint : `/${endpoint}`
  }`;

  const options = {
    method,
    headers: getHeaders(includeAuth),
  };

  if (body) options.body = JSON.stringify(body);

  try {
    const response = await fetch(url, options);
    return await handleResponse(response);
  } catch (error) {
    console.error("üåê Error de conexi√≥n con el servidor:", error);
    throw new Error(
      "No se pudo conectar con el servidor. Verifica tu red o que el backend est√© activo."
    );
  }
};

// ========================================================================
// ‚úÖ Exportaci√≥n adicional compatible con otros imports
// ========================================================================
export const API_URL = API_BASE; // Alias usado en m√≥dulos antiguos
export default API_BASE;