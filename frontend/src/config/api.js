// ========================================================================
// üåç CONFIGURACI√ìN GLOBAL DEL CLIENTE API - CENATE (CRA / Docker / Nginx)
// ========================================================================

/**
 * üß† Detecta la URL base del backend seg√∫n el entorno:
 * - En desarrollo local: apunta a http://localhost:8080/api
 * - En producci√≥n (Docker / Nginx): usa el proxy interno /api
 */
const getApiBaseUrl = () => {
  // 1Ô∏è‚É£ Intentar leer variable de entorno definida en .env o docker-compose
  const envUrl = process.env.REACT_APP_API_URL;

  if (envUrl && envUrl.trim() !== "") {
    return envUrl.trim().replace(/\/$/, ""); // limpia barra final
  }

  // 2Ô∏è‚É£ Detectar entorno de ejecuci√≥n (CRA local vs Nginx)
  const hostname = typeof window !== "undefined" ? window.location.hostname : "";

  // Si est√° dentro de Docker/Nginx ‚Üí usa proxy interno /api
  // Si est√° ejecut√°ndose con npm start (localhost:3000) ‚Üí usa backend directo
  if (hostname === "localhost" && window.location.port === "3000") {
    return "http://localhost:8080/api";
  }

  // üîÅ Fallback por defecto (producci√≥n con Nginx)
  return "/api";
};

// üåê Base de la API
export const API_BASE = getApiBaseUrl();

// ========================================================================
// üß± HEADERS GENERALES
// ========================================================================
export const getHeaders = (includeAuth = false) => {
  const headers = {
    "Content-Type": "application/json",
    Accept: "application/json",
  };

  if (includeAuth) {
    const token = localStorage.getItem("token");
    if (token) headers.Authorization = `Bearer ${token}`;
  }

  return headers;
};

// ========================================================================
// ‚öôÔ∏è MANEJO DE RESPUESTAS
// ========================================================================
export const handleResponse = async (response) => {
  let data;

  try {
    data = await response.json();
  } catch {
    data = { message: "Respuesta no v√°lida del servidor." };
  }

  if (!response.ok) {
    const errorMessage =
      data?.message ||
      (response.status === 401
        ? "‚ö†Ô∏è Sesi√≥n expirada o no autorizada."
        : response.status === 403
        ? "üö´ No tienes permisos para esta acci√≥n."
        : `Error ${response.status}: ${response.statusText}`);

    console.error("‚ùå Error de API:", errorMessage, data);
    throw new Error(errorMessage);
  }

  return data;
};

// ========================================================================
// üöÄ PETICI√ìN GEN√âRICA UNIVERSAL
// ========================================================================
export const apiRequest = async (
  endpoint,
  method = "GET",
  body = null,
  includeAuth = false
) => {
  const url = `${API_BASE}${endpoint.startsWith("/") ? endpoint : `/${endpoint}`}`;

  const options = {
    method,
    headers: getHeaders(includeAuth),
  };

  if (body) options.body = JSON.stringify(body);

  try {
    const response = await fetch(url, options);
    return await handleResponse(response);
  } catch (error) {
    console.error("üåê Error de conexi√≥n con el servidor:", error);
    throw new Error(
      "No se pudo conectar con el servidor. Verifica tu red o que el backend est√© activo."
    );
  }
};

// ========================================================================
// ü™Ñ Exportaci√≥n adicional (compatibilidad retro)
// ========================================================================
export const API_URL = API_BASE;
export default API_BASE;