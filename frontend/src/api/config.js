// ========================================================================
// üåç CONFIGURACI√ìN GLOBAL DEL CLIENTE API - CENATE
// ========================================================================

// URL base del backend (configurable por entorno)
const API_BASE_URL = process.env.REACT_APP_API_URL || "http://localhost:8080/api";

/**
 * üîß Genera encabezados HTTP para las solicitudes
 * @param {boolean} includeAuth - Si debe incluir el token JWT
 */
const getHeaders = (includeAuth = false) => {
  const headers = {
    "Content-Type": "application/json",
  };

  if (includeAuth) {
    const token = localStorage.getItem("token");
    if (token) headers["Authorization"] = `Bearer ${token}`;
  }

  return headers;
};

/**
 * ‚öôÔ∏è Maneja las respuestas del servidor y lanza errores si es necesario
 * @param {Response} response
 */
const handleResponse = async (response) => {
  let data;
  try {
    data = await response.json();
  } catch {
    data = { message: "Respuesta no v√°lida del servidor" };
  }

  if (!response.ok) {
    throw new Error(data.message || `Error ${response.status}`);
  }

  return data;
};

// ========================================================================
// üß† AUTENTICACI√ìN
// ========================================================================

/**
 * üîê Inicia sesi√≥n con usuario y contrase√±a
 */
export const loginUser = async (username, password) => {
  try {
    const response = await fetch(`${API_BASE_URL}/auth/login`, {
      method: "POST",
      headers: getHeaders(),
      body: JSON.stringify({ username, password }),
    });
    const data = await handleResponse(response);
    console.log("‚úÖ Login exitoso:", data);
    return data;
  } catch (error) {
    console.error("‚ùå Error en loginUser:", error);
    throw error;
  }
};

/**
 * üö™ Cierra sesi√≥n y limpia el almacenamiento local
 */
export const logoutUser = async () => {
  try {
    await fetch(`${API_BASE_URL}/auth/logout`, {
      method: "POST",
      headers: getHeaders(true),
    });
  } catch (error) {
    console.error("‚ö†Ô∏è Error cerrando sesi√≥n:", error);
  } finally {
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    localStorage.removeItem("roles");
  }
};

/**
 * üë§ Registra un nuevo usuario
 */
export const registerUser = async (userData) => {
  try {
    const response = await fetch(`${API_BASE_URL}/auth/register`, {
      method: "POST",
      headers: getHeaders(),
      body: JSON.stringify(userData),
    });
    return await handleResponse(response);
  } catch (error) {
    console.error("‚ùå Error en registerUser:", error);
    throw error;
  }
};

/**
 * üßæ Obtiene el perfil del usuario autenticado
 */
export const getUserProfile = async () => {
  try {
    const response = await fetch(`${API_BASE_URL}/auth/profile`, {
      method: "GET",
      headers: getHeaders(true),
    });
    return await handleResponse(response);
  } catch (error) {
    console.error("‚ùå Error en getUserProfile:", error);
    throw error;
  }
};

/**
 * üì© Env√≠a correo para recuperaci√≥n de contrase√±a
 */
export const forgotPassword = async (email) => {
  try {
    const response = await fetch(`${API_BASE_URL}/auth/forgot-password`, {
      method: "POST",
      headers: getHeaders(),
      body: JSON.stringify({ email }),
    });
    return await handleResponse(response);
  } catch (error) {
    console.error("‚ùå Error en forgotPassword:", error);
    throw error;
  }
};

/**
 * üîë Restablece la contrase√±a usando token de recuperaci√≥n
 */
export const resetPassword = async (token, newPassword) => {
  try {
    const response = await fetch(`${API_BASE_URL}/auth/reset-password`, {
      method: "POST",
      headers: getHeaders(),
      body: JSON.stringify({ token, newPassword }),
    });
    return await handleResponse(response);
  } catch (error) {
    console.error("‚ùå Error en resetPassword:", error);
    throw error;
  }
};

// ========================================================================
// üë• CRUD USUARIOS
// ========================================================================

export const getUsuarios = async () => {
  const response = await fetch(`${API_BASE_URL}/usuarios`, {
    headers: getHeaders(true),
  });
  return handleResponse(response);
};

export const getUsuarioById = async (id) => {
  const response = await fetch(`${API_BASE_URL}/usuarios/${id}`, {
    headers: getHeaders(true),
  });
  return handleResponse(response);
};

export const createUsuario = async (usuario) => {
  const response = await fetch(`${API_BASE_URL}/usuarios`, {
    method: "POST",
    headers: getHeaders(true),
    body: JSON.stringify(usuario),
  });
  return handleResponse(response);
};

export const updateUsuario = async (id, usuario) => {
  const response = await fetch(`${API_BASE_URL}/usuarios/${id}`, {
    method: "PUT",
    headers: getHeaders(true),
    body: JSON.stringify(usuario),
  });
  return handleResponse(response);
};

export const deleteUsuario = async (id) => {
  const response = await fetch(`${API_BASE_URL}/usuarios/${id}`, {
    method: "DELETE",
    headers: getHeaders(true),
  });
  return handleResponse(response);
};

// ========================================================================
// üß¨ CRUD PACIENTES
// ========================================================================

export const getPacientes = async () => {
  const response = await fetch(`${API_BASE_URL}/pacientes`, {
    headers: getHeaders(true),
  });
  return handleResponse(response);
};

export const getPacienteById = async (id) => {
  const response = await fetch(`${API_BASE_URL}/pacientes/${id}`, {
    headers: getHeaders(true),
  });
  return handleResponse(response);
};

export const createPaciente = async (paciente) => {
  const response = await fetch(`${API_BASE_URL}/pacientes`, {
    method: "POST",
    headers: getHeaders(true),
    body: JSON.stringify(paciente),
  });
  return handleResponse(response);
};

export const updatePaciente = async (id, paciente) => {
  const response = await fetch(`${API_BASE_URL}/pacientes/${id}`, {
    method: "PUT",
    headers: getHeaders(true),
    body: JSON.stringify(paciente),
  });
  return handleResponse(response);
};

export const deletePaciente = async (id) => {
  const response = await fetch(`${API_BASE_URL}/pacientes/${id}`, {
    method: "DELETE",
    headers: getHeaders(true),
  });
  return handleResponse(response);
};

// ========================================================================
// üß™ CRUD EX√ÅMENES
// ========================================================================

export const getExamenes = async () => {
  const response = await fetch(`${API_BASE_URL}/examenes`, {
    headers: getHeaders(true),
  });
  return handleResponse(response);
};

export const getExamenById = async (id) => {
  const response = await fetch(`${API_BASE_URL}/examenes/${id}`, {
    headers: getHeaders(true),
  });
  return handleResponse(response);
};

export const createExamen = async (examen) => {
  const response = await fetch(`${API_BASE_URL}/examenes`, {
    method: "POST",
    headers: getHeaders(true),
    body: JSON.stringify(examen),
  });
  return handleResponse(response);
};

export const updateExamen = async (id, examen) => {
  const response = await fetch(`${API_BASE_URL}/examenes/${id}`, {
    method: "PUT",
    headers: getHeaders(true),
    body: JSON.stringify(examen),
  });
  return handleResponse(response);
};

export const deleteExamen = async (id) => {
  const response = await fetch(`${API_BASE_URL}/examenes/${id}`, {
    method: "DELETE",
    headers: getHeaders(true),
  });
  return handleResponse(response);
};

// ========================================================================
// üåê EXPORTS GLOBALES
// ========================================================================

export { API_BASE_URL, getHeaders, handleResponse };
