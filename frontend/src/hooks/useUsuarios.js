// src/hooks/useUsuarios.js
import { useState, useEffect } from "react";
import {
    getUsuarios,
    getUsuarioById,
    createUsuario,
    updateUsuario,
    deleteUsuario,
} from "../api/usuarios";
import {
    login,
    getCurrentUser,
    forgotPassword,
    changePassword,
} from "../api/auth"; // ‚úÖ ahora importamos todas las funciones de autenticaci√≥n

/**
 * Hook centralizado para manejar autenticaci√≥n y usuarios.
 */
export const useUsuarios = () => {
    // Estados globales
    const [usuarios, setUsuarios] = useState([]);
    const [usuarioActual, setUsuarioActual] = useState(null);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState("");

    // ======================================================
    // üîê AUTENTICACI√ìN
    // ======================================================

    /** üîë Login de usuario */
    const loginUser = async (username, password) => {
        setLoading(true);
        setError("");
        try {
            const data = await login(username, password);
            if (data?.token) {
                localStorage.setItem("token", data.token);
                localStorage.setItem("username", data.username || "");
                localStorage.setItem("userId", data.userId || "");
                localStorage.setItem("roles", JSON.stringify(data.roles || []));
                localStorage.setItem("permisos", JSON.stringify(data.permisos || []));
                setUsuarioActual(data);
            }
            return data;
        } catch (err) {
            console.error("‚ùå Error en login:", err);
            setError(err.message || "Error al iniciar sesi√≥n");
            throw err;
        } finally {
            setLoading(false);
        }
    };

    /** üë§ Cargar usuario autenticado actual */
    const loadCurrentUser = async () => {
        try {
            const data = await getCurrentUser();
            setUsuarioActual(data);
        } catch (err) {
            console.warn("‚ö†Ô∏è No se pudo obtener el usuario actual:", err);
        }
    };

    /** üö™ Logout */
    const logout = () => {
        localStorage.clear();
        setUsuarioActual(null);
    };

    // ======================================================
    // üîÅ RECUPERAR / CAMBIAR CONTRASE√ëA
    // ======================================================

    /** üì© Recuperar contrase√±a */
    const recoverPassword = async (email) => {
        setLoading(true);
        setError("");
        try {
            const data = await forgotPassword(email);
            return data;
        } catch (err) {
            setError("Error al enviar correo de recuperaci√≥n.");
            throw err;
        } finally {
            setLoading(false);
        }
    };

    /** üîí Cambiar contrase√±a (usuario autenticado) */
    const updatePassword = async (currentPassword, newPassword, confirmPassword) => {
        setLoading(true);
        setError("");
        try {
            const data = await changePassword(currentPassword, newPassword, confirmPassword);
            return data;
        } catch (err) {
            setError("Error al cambiar la contrase√±a.");
            throw err;
        } finally {
            setLoading(false);
        }
    };

    // ======================================================
    // üë• CRUD de usuarios (ya existente)
    // ======================================================
    const fetchUsuarios = async () => {
        setLoading(true);
        try {
            const data = await getUsuarios();
            setUsuarios(data);
        } catch (err) {
            setError("Error al obtener usuarios");
        } finally {
            setLoading(false);
        }
    };

    const fetchUsuarioById = async (id) => {
        setLoading(true);
        try {
            return await getUsuarioById(id);
        } catch (err) {
            setError("Error al obtener usuario");
        } finally {
            setLoading(false);
        }
    };

    const addUsuario = async (usuario) => {
        try {
            const data = await createUsuario(usuario);
            setUsuarios([...usuarios, data]);
        } catch (err) {
            setError("Error al crear usuario");
        }
    };

    const editUsuario = async (id, usuario) => {
        try {
            const data = await updateUsuario(id, usuario);
            setUsuarios(usuarios.map((u) => (u.id === id ? data : u)));
        } catch (err) {
            setError("Error al actualizar usuario");
        }
    };

    const removeUsuario = async (id) => {
        try {
            await deleteUsuario(id);
            setUsuarios(usuarios.filter((u) => u.id !== id));
        } catch (err) {
            setError("Error al eliminar usuario");
        }
    };

    // ======================================================
    // ‚öôÔ∏è Efecto inicial
    // ======================================================
    useEffect(() => {
        const token = localStorage.getItem("token");
        if (token) loadCurrentUser();
    }, []);

    // ======================================================
    // üîÅ Retorno del hook
    // ======================================================
    return {
        usuarios,
        usuarioActual,
        loading,
        error,
        loginUser,
        logout,
        loadCurrentUser,
        recoverPassword,
        updatePassword,
        fetchUsuarios,
        fetchUsuarioById,
        addUsuario,
        editUsuario,
        removeUsuario,
    };
};