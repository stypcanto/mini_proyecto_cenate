// ========================================================================
// üåç CLIENTE GLOBAL DE API - CENATE (React + Docker + Nginx)
// ========================================================================
//
// Este cliente maneja autom√°ticamente:
//   - Detecci√≥n del entorno (local vs Docker/Nginx)
//   - Headers con y sin autenticaci√≥n
//   - Manejo centralizado de errores
//   - Funciones HTTP auxiliares: get, post, put, delete
//
// Uso sugerido en /src/api/*
// import { apiClient } from "@/lib/apiClient";
// const data = await apiClient.get("/pacientes", true);
// ========================================================================

// ------------------------------------------------------
// üîé Determina la URL base de la API
// ------------------------------------------------------
const getApiBaseUrl = () => {
  const envUrl = process.env.REACT_APP_API_URL || import.meta?.env?.VITE_API_URL;

  if (envUrl && envUrl.trim() !== "") {
    return envUrl.trim().replace(/\/$/, ""); // limpia barra final
  }

  const hostname =
    typeof window !== "undefined" ? window.location.hostname : "";

  if (hostname === "localhost" && window.location.port === "3000") {
    // üß© CRA local (npm start)
    return "http://localhost:8080/api";
  }

  // üåê Producci√≥n o entorno Docker/Nginx
  return "/api";
};

export const API_BASE = getApiBaseUrl();

// ------------------------------------------------------
// üß± Headers b√°sicos
// ------------------------------------------------------
export const getHeaders = (includeAuth = false) => {
  const headers = {
    "Content-Type": "application/json",
    Accept: "application/json",
  };

  if (includeAuth) {
    const token = localStorage.getItem("token");
    if (token) headers.Authorization = `Bearer ${token}`;
  }

  return headers;
};

// ------------------------------------------------------
// ‚öôÔ∏è Manejo centralizado de respuestas
// ------------------------------------------------------
export const handleResponse = async (response) => {
  let data;
  try {
    data = await response.json();
  } catch {
    data = { message: "Respuesta no v√°lida del servidor." };
  }

  if (!response.ok) {
    const message =
      data?.message ||
      (response.status === 401
        ? "‚ö†Ô∏è Sesi√≥n expirada o no autorizada."
        : response.status === 403
        ? "üö´ No tienes permisos para esta acci√≥n."
        : `Error ${response.status}: ${response.statusText}`);

    console.error("‚ùå Error de API:", message, data);
    throw new Error(message);
  }

  return data;
};

// ------------------------------------------------------
// üöÄ Funci√≥n principal gen√©rica de peticiones
// ------------------------------------------------------
export const apiRequest = async (
  endpoint,
  method = "GET",
  body = null,
  includeAuth = false
) => {
  const url = `${API_BASE}${endpoint.startsWith("/") ? endpoint : `/${endpoint}`}`;

  const options = {
    method,
    headers: getHeaders(includeAuth),
  };

  if (body) options.body = JSON.stringify(body);

  try {
    const response = await fetch(url, options);
    return await handleResponse(response);
  } catch (error) {
    console.error("üåê Error de conexi√≥n con el servidor:", error);
    throw new Error(
      "No se pudo conectar con el servidor. Verifica tu red o que el backend est√© activo."
    );
  }
};

// ------------------------------------------------------
// ü™Ñ API Helpers (m√°s limpio en /src/api/*)
// ------------------------------------------------------
export const apiClient = {
  get: (endpoint, auth = false) => apiRequest(endpoint, "GET", null, auth),
  post: (endpoint, body, auth = false) => apiRequest(endpoint, "POST", body, auth),
  put: (endpoint, body, auth = false) => apiRequest(endpoint, "PUT", body, auth),
  delete: (endpoint, auth = false) => apiRequest(endpoint, "DELETE", null, auth),
};

// ------------------------------------------------------
// üîÅ Exportaciones por compatibilidad
// ------------------------------------------------------
export const API_URL = API_BASE;
export default API_BASE;