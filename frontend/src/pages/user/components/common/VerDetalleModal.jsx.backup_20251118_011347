// src/pages/admin/users/components/modals/VerDetalleModal.jsx
import React, { useMemo, useState } from 'react';
import { 
  X, User, Mail, Phone, MapPin, Building, Calendar, 
  Hash, Clock, Shield, Briefcase, Home, CreditCard, GraduationCap 
} from 'lucide-react';

const VerDetalleModal = ({ user, onClose }) => {
  const [selectedTab, setSelectedTab] = useState('personal');

  // Funci√≥n para obtener las iniciales del usuario
  const getInitials = (nombreCompleto) => {
    if (!nombreCompleto) return user.username?.charAt(0).toUpperCase() || '?';
    const names = nombreCompleto.trim().split(' ');
    if (names.length === 1) return names[0].charAt(0).toUpperCase();
    return (names[0].charAt(0) + names[names.length - 1].charAt(0)).toUpperCase();
  };

  // Calcular edad
  const calcularEdad = (fechaNacimiento) => {
    if (!fechaNacimiento) return null;
    try {
      let date;
      if (typeof fechaNacimiento === 'string') {
        date = new Date(fechaNacimiento);
      } else if (Array.isArray(fechaNacimiento)) {
        date = new Date(fechaNacimiento[0], fechaNacimiento[1] - 1, fechaNacimiento[2]);
      } else {
        date = new Date(fechaNacimiento);
      }
      
      if (isNaN(date.getTime())) return null;
      
      const hoy = new Date();
      let edad = hoy.getFullYear() - date.getFullYear();
      const mes = hoy.getMonth() - date.getMonth();
      if (mes < 0 || (mes === 0 && hoy.getDate() < date.getDate())) {
        edad--;
      }
      return edad;
    } catch (e) {
      return null;
    }
  };

  // Formatear fecha de cumplea√±os
  const formatearCumpleanos = (fechaNacimiento) => {
    if (!fechaNacimiento) return '‚Äî';
    try {
      let date;
      if (typeof fechaNacimiento === 'string') {
        date = new Date(fechaNacimiento);
      } else if (Array.isArray(fechaNacimiento)) {
        date = new Date(fechaNacimiento[0], fechaNacimiento[1] - 1, fechaNacimiento[2]);
      } else {
        date = new Date(fechaNacimiento);
      }
      
      if (isNaN(date.getTime())) return '‚Äî';
      
      const dia = date.getDate();
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                     'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      const mes = meses[date.getMonth()];
      return `${dia} de ${mes}`;
    } catch (e) {
      return '‚Äî';
    }
  };

  // Formatear fecha completa
  const formatearFechaCompleta = (fecha) => {
    if (!fecha) return '‚Äî';
    try {
      let date;
      if (typeof fecha === 'string') {
        date = new Date(fecha);
      } else if (Array.isArray(fecha)) {
        date = new Date(fecha[0], fecha[1] - 1, fecha[2]);
      } else {
        date = new Date(fecha);
      }
      
      if (isNaN(date.getTime())) return '‚Äî';
      
      return date.toLocaleDateString('es-PE', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    } catch (e) {
      return '‚Äî';
    }
  };

  // Formatear periodo (de YYYYMM a "Mes A√±o")
  const formatearPeriodo = (periodo) => {
    if (!periodo) return '‚Äî';
    try {
      const periodoStr = String(periodo);
      if (periodoStr.length !== 6) return periodo;
      
      const year = periodoStr.substring(0, 4);
      const month = periodoStr.substring(4, 6);
      
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                     'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      const monthIndex = parseInt(month) - 1;
      
      if (monthIndex < 0 || monthIndex > 11) return periodo;
      
      return `${meses[monthIndex]} ${year}`;
    } catch (e) {
      return periodo;
    }
  };

  // Formatear fecha y hora
  const formatearFechaHora = (fechaHora) => {
    if (!fechaHora) return '‚Äî';
    try {
      const date = new Date(fechaHora);
      if (isNaN(date.getTime())) return '‚Äî';
      
      return date.toLocaleString('es-PE', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
    } catch (e) {
      return '‚Äî';
    }
  };

  const edad = useMemo(() => calcularEdad(user.fecha_nacimiento), [user.fecha_nacimiento]);
  const cumpleanos = useMemo(() => formatearCumpleanos(user.fecha_nacimiento), [user.fecha_nacimiento]);

  // Badge de estado
  const getEstadoBadge = (estado) => {
    if (estado === 'ACTIVO') {
      return (
        <span className="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-emerald-100 text-emerald-700">
          ACTIVO
        </span>
      );
    }
    return (
      <span className="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-700">
        INACTIVO
      </span>
    );
  };

  // Badge de tipo personal
  const getTipoBadge = (tipo) => {
    if (tipo === 'INTERNO') {
      return (
        <span className="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-emerald-100 text-emerald-700">
          INTERNO
        </span>
      );
    }
    if (tipo === 'EXTERNO') {
      return (
        <span className="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-700">
          EXTERNO
        </span>
      );
    }
    return (
      <span className="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-700">
        {tipo || 'SIN DATOS'}
      </span>
    );
  };

  // Badge de rol
  const getRolBadge = (rol) => {
    // Si roles es un array, tomar el primer elemento
    const rolTexto = Array.isArray(rol) ? rol[0] : rol;
    return (
      <span className="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-700">
        {rolTexto || 'USER'}
      </span>
    );
  };

  // Componente de campo de informaci√≥n
  const InfoField = ({ icon: Icon, label, value, fullWidth = false }) => (
    <div className={`${fullWidth ? 'col-span-2' : ''}`}>
      <label className="flex items-center gap-2 mb-2 text-xs font-medium text-gray-500 uppercase">
        {Icon && <Icon className="w-4 h-4" />}
        {label}
      </label>
      <div className="px-4 py-3 text-sm font-medium text-gray-900 bg-gray-50 border border-gray-200 rounded-lg">
        {value || <span className="text-gray-400 italic">No especificado</span>}
      </div>
    </div>
  );

  // Verificar si hay datos profesionales
  const tieneDatosProfesionales = user.nombre_profesion || user.colegiatura || user.nombre_especialidad || user.rne;
  
  // Verificar si hay datos laborales adicionales
  const tieneDatosLaboralesAdicionales = user.nombre_area || user.nombre_regimen || user.codigo_planilla || user.periodo_ingreso;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm overflow-y-auto">
      <div className="w-full max-w-4xl bg-white shadow-2xl rounded-2xl overflow-hidden my-8 flex flex-col max-h-[90vh]">
        {/* Header con foto y badges */}
        <div className="relative bg-gradient-to-r from-slate-800 to-slate-700 px-6 py-6">
          <button
            onClick={onClose}
            className="absolute top-4 right-4 p-2 text-white hover:bg-white/10 rounded-lg transition-all"
          >
            <X className="w-5 h-5" />
          </button>

          <div className="flex items-center gap-4">
            {/* Avatar */}
            <div className="w-16 h-16 rounded-full bg-gradient-to-br from-emerald-400 to-blue-500 flex items-center justify-center text-white font-bold text-xl shadow-lg border-4 border-white/20">
              {getInitials(user.nombre_completo)}
            </div>

            {/* Info del usuario */}
            <div className="flex-1">
              <h2 className="text-xl font-bold text-white mb-1">
                {user.nombre_completo || 'Usuario sin nombre'}
              </h2>
              <p className="text-slate-300 text-sm">@{user.username}</p>
            </div>
          </div>

          {/* Badges */}
          <div className="flex flex-wrap gap-2 mt-3">
            {getEstadoBadge(user.estado_usuario)}
            {getTipoBadge(user.tipo_personal)}
            {getRolBadge(user.roles)}
          </div>

          {/* Tabs - 4 PESTA√ëAS */}
          <div className="flex gap-2 mt-4">
            <button
              onClick={() => setSelectedTab('personal')}
              className={`px-4 py-2 font-medium text-sm rounded-t-xl transition-all ${
                selectedTab === 'personal'
                  ? 'bg-white text-slate-900'
                  : 'bg-slate-700/40 text-slate-100 hover:bg-slate-700/60'
              }`}
            >
              Datos Personales
            </button>
            <button
              onClick={() => setSelectedTab('profesionales')}
              className={`px-4 py-2 font-medium text-sm rounded-t-xl transition-all ${
                selectedTab === 'profesionales'
                  ? 'bg-white text-slate-900'
                  : 'bg-slate-700/40 text-slate-100 hover:bg-slate-700/60'
              }`}
            >
              Datos Profesionales
            </button>
            <button
              onClick={() => setSelectedTab('laborales')}
              className={`px-4 py-2 font-medium text-sm rounded-t-xl transition-all ${
                selectedTab === 'laborales'
                  ? 'bg-white text-slate-900'
                  : 'bg-slate-700/40 text-slate-100 hover:bg-slate-700/60'
              }`}
            >
              Datos Laborales
            </button>
            <button
              onClick={() => setSelectedTab('roles')}
              className={`px-4 py-2 font-medium text-sm rounded-t-xl transition-all ${
                selectedTab === 'roles'
                  ? 'bg-white text-slate-900'
                  : 'bg-slate-700/40 text-slate-100 hover:bg-slate-700/60'
              }`}
            >
              Roles del Sistema
            </button>
          </div>
        </div>

        {/* Contenido por pesta√±as */}
        <div className="p-6 overflow-y-auto flex-1">
          {/* PESTA√ëA: DATOS PERSONALES */}
          {selectedTab === 'personal' && (
            <div className="space-y-6">
              {/* Informaci√≥n Personal */}
              <div>
                <div className="flex items-center gap-2 mb-4 pb-2 border-b-2 border-gray-200">
                  <User className="w-5 h-5 text-gray-700" />
                  <h3 className="text-base font-bold text-gray-900 uppercase tracking-wide">
                    Informaci√≥n Personal
                  </h3>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InfoField 
                    icon={CreditCard}
                    label="Documento" 
                    value={`${user.tipo_documento || 'DNI'}: ${user.numero_documento || '‚Äî'}`} 
                  />
                  <InfoField 
                    icon={User}
                    label="Nombres" 
                    value={user.nombres} 
                  />
                  <InfoField 
                    icon={User}
                    label="Apellido Paterno" 
                    value={user.apellido_paterno} 
                  />
                  <InfoField 
                    icon={User}
                    label="Apellido Materno" 
                    value={user.apellido_materno} 
                  />
                  <InfoField 
                    icon={User}
                    label="G√©nero" 
                    value={user.genero === 'M' ? 'Masculino' : user.genero === 'F' ? 'Femenino' : user.genero} 
                  />
                  <InfoField 
                    icon={Calendar}
                    label="Fecha de Nacimiento" 
                    value={formatearFechaCompleta(user.fecha_nacimiento)} 
                  />
                  <InfoField 
                    icon={Calendar}
                    label="Edad" 
                    value={edad ? `${edad} a√±os` : '‚Äî'} 
                  />
                  <InfoField 
                    icon={Calendar}
                    label="Cumplea√±os" 
                    value={cumpleanos} 
                  />
                </div>
              </div>

              {/* Informaci√≥n de Contacto */}
              <div>
                <div className="flex items-center gap-2 mb-4 pb-2 border-b-2 border-gray-200">
                  <Mail className="w-5 h-5 text-gray-700" />
                  <h3 className="text-base font-bold text-gray-900 uppercase tracking-wide">
                    Informaci√≥n de Contacto
                  </h3>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InfoField 
                    icon={Mail}
                    label="Correo Institucional" 
                    value={user.correo_institucional || user.correo_corporativo} 
                  />
                  <InfoField 
                    icon={Mail}
                    label="Correo Personal" 
                    value={user.correo_personal} 
                  />
                  <InfoField 
                    icon={Phone}
                    label="Tel√©fono" 
                    value={user.telefono} 
                  />
                  <InfoField 
                    icon={Home}
                    label="Direcci√≥n" 
                    value={user.direccion} 
                  />
                </div>
              </div>
            </div>
          )}

          {/* PESTA√ëA: DATOS PROFESIONALES */}
          {selectedTab === 'profesionales' && (
            <div className="space-y-6">
              <div>
                <div className="flex items-center gap-2 mb-4 pb-2 border-b-2 border-gray-200">
                  <GraduationCap className="w-5 h-5 text-gray-700" />
                  <h3 className="text-base font-bold text-gray-900 uppercase tracking-wide">
                    Informaci√≥n Profesional
                  </h3>
                </div>
                
                {/* Verificar si hay informaci√≥n profesional */}
                {!tieneDatosProfesionales ? (
                  <div className="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl">
                    <div className="text-center">
                      <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-blue-100 flex items-center justify-center">
                        <GraduationCap className="w-8 h-8 text-blue-600" />
                      </div>
                      <h4 className="text-lg font-semibold text-blue-900 mb-2">
                        No hay informaci√≥n profesional registrada
                      </h4>
                      <p className="text-sm text-blue-700">
                        Este usuario no complet√≥ sus datos profesionales durante la creaci√≥n de cuenta.
                      </p>
                      <p className="text-xs text-blue-600 mt-2">
                        üí° <strong>Nota:</strong> Estos campos son opcionales y pueden ser completados m√°s tarde si es necesario.
                      </p>
                    </div>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <InfoField 
                      icon={GraduationCap}
                      label="Profesi√≥n" 
                      value={user.nombre_profesion} 
                    />
                    <InfoField 
                      icon={CreditCard}
                      label="Colegiatura" 
                      value={user.colegiatura} 
                    />
                    <InfoField 
                      icon={GraduationCap}
                      label="Especialidad" 
                      value={user.nombre_especialidad} 
                    />
                    <InfoField 
                      icon={Hash}
                      label="RNE" 
                      value={user.rne} 
                    />
                  </div>
                )}
              </div>
            </div>
          )}

          {/* PESTA√ëA: DATOS LABORALES */}
          {selectedTab === 'laborales' && (
            <div className="space-y-6">
              <div>
                <div className="flex items-center gap-2 mb-4 pb-2 border-b-2 border-gray-200">
                  <Briefcase className="w-5 h-5 text-gray-700" />
                  <h3 className="text-base font-bold text-gray-900 uppercase tracking-wide">
                    Informaci√≥n Laboral
                  </h3>
                </div>
                
                {/* Siempre mostrar IPRESS y Tipo de Personal (datos b√°sicos) */}
                <div className="mb-6">
                  <h4 className="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">
                    üè¢ Informaci√≥n B√°sica Laboral
                  </h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <InfoField 
                      icon={Building}
                      label="IPRESS" 
                      value={user.nombre_ipress} 
                    />
                    <InfoField 
                      icon={User}
                      label="Tipo de Personal" 
                      value={user.tipo_personal || user.tipo_personal_detalle || (user.id_ipress === 2 ? 'INTERNO' : 'EXTERNO')} 
                    />
                  </div>
                </div>
                
                {/* Datos adicionales (opcionales) */}
                <div>
                  <h4 className="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">
                    üíº Informaci√≥n Laboral Adicional
                  </h4>
                  {!tieneDatosLaboralesAdicionales ? (
                    <div className="p-6 bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-200 rounded-xl">
                      <div className="text-center">
                        <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-amber-100 flex items-center justify-center">
                          <Briefcase className="w-8 h-8 text-amber-600" />
                        </div>
                        <h4 className="text-lg font-semibold text-amber-900 mb-2">
                          No hay informaci√≥n laboral adicional
                        </h4>
                        <p className="text-sm text-amber-700">
                          Este usuario no complet√≥ los datos de √°rea, r√©gimen laboral, c√≥digo de planilla o periodo de ingreso.
                        </p>
                        <p className="text-xs text-amber-600 mt-2">
                          üí° <strong>Nota:</strong> Estos campos son opcionales y pueden ser completados m√°s tarde si es necesario.
                        </p>
                      </div>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <InfoField 
                        icon={Briefcase}
                        label="√Årea" 
                        value={user.nombre_area || user.area_trabajo} 
                      />
                      <InfoField 
                        icon={Briefcase}
                        label="R√©gimen Laboral" 
                        value={user.nombre_regimen || user.regimen_laboral} 
                      />
                      <InfoField 
                        icon={Hash}
                        label="C√≥digo de Planilla" 
                        value={user.codigo_planilla} 
                      />
                      <InfoField 
                        icon={Calendar}
                        label="Periodo de Ingreso" 
                        value={formatearPeriodo(user.periodo_ingreso)} 
                      />
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* PESTA√ëA: ROLES DEL SISTEMA */}
          {selectedTab === 'roles' && (
            <div className="space-y-6">
              <div>
                <div className="flex items-center gap-2 mb-4 pb-2 border-b-2 border-gray-200">
                  <Shield className="w-5 h-5 text-gray-700" />
                  <h3 className="text-base font-bold text-gray-900 uppercase tracking-wide">
                    Informaci√≥n del Sistema
                  </h3>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InfoField 
                    icon={User}
                    label="Usuario" 
                    value={user.username} 
                  />
                  <InfoField 
                    icon={Shield}
                    label="Roles" 
                    value={Array.isArray(user.roles) ? user.roles.join(', ') : user.roles} 
                  />
                  <InfoField 
                    icon={Hash}
                    label="ID de Usuario" 
                    value={user.id_user || user.id_usuario} 
                  />
                  <InfoField 
                    icon={Shield}
                    label="Estado" 
                    value={user.estado_usuario} 
                  />
                  <InfoField 
                    icon={Clock}
                    label="Fecha de Registro" 
                    value={formatearFechaHora(user.create_at || user.created_at)} 
                  />
                  <InfoField 
                    icon={Clock}
                    label="√öltima Actualizaci√≥n" 
                    value={formatearFechaHora(user.update_at || user.updated_at)} 
                  />
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
          <div className="text-xs text-gray-500">
            ID: {user.id_user || user.id_usuario || user.id_personal}
          </div>
          <button
            onClick={onClose}
            className="px-6 py-2.5 bg-slate-700 hover:bg-slate-800 text-white rounded-lg font-medium transition-all shadow-sm"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>
  );
};

export default VerDetalleModal;
