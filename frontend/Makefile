# ============================================================
# Makefile - Frontend CENATE (React)
# ============================================================
# Uso: make <comando>
# ============================================================

.PHONY: help dev start build clean test install lint format

# Colores para output
GREEN  := \033[0;32m
YELLOW := \033[0;33m
BLUE   := \033[0;34m
NC     := \033[0m # No Color

# Variables
NPM = npm
PORT_LOCAL = 3000
API_LOCAL = http://localhost:8080
API_NETWORK = http://10.0.89.239:8080

# ============================================================
# AYUDA
# ============================================================
help:
	@echo ""
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(GREEN)  Makefile - Frontend CENATE (React)$(NC)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)Comandos disponibles:$(NC)"
	@echo ""
	@echo "  $(GREEN)make dev$(NC)          - Iniciar en desarrollo (API local)"
	@echo "  $(GREEN)make dev-network$(NC)  - Iniciar en desarrollo (API red)"
	@echo "  $(GREEN)make start$(NC)        - Iniciar aplicaciÃ³n"
	@echo "  $(GREEN)make build$(NC)        - Compilar para producciÃ³n"
	@echo "  $(GREEN)make install$(NC)      - Instalar dependencias"
	@echo "  $(GREEN)make clean$(NC)        - Limpiar node_modules y build"
	@echo "  $(GREEN)make lint$(NC)         - Ejecutar linter"
	@echo "  $(GREEN)make test$(NC)         - Ejecutar tests"
	@echo "  $(GREEN)make open$(NC)         - Abrir en navegador"
	@echo "  $(GREEN)make deps$(NC)         - Ver dependencias instaladas"
	@echo "  $(GREEN)make update$(NC)       - Actualizar dependencias"
	@echo ""
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""

# ============================================================
# DESARROLLO
# ============================================================

## Iniciar en modo desarrollo (API localhost)
dev:
	@echo "$(GREEN)ðŸš€ Iniciando frontend en modo desarrollo...$(NC)"
	@echo "$(YELLOW)   Puerto: $(PORT_LOCAL)$(NC)"
	@echo "$(YELLOW)   API: $(API_LOCAL)$(NC)"
	@echo ""
	REACT_APP_API_URL=$(API_LOCAL)/api $(NPM) start

## Iniciar en modo desarrollo (API en red)
dev-network:
	@echo "$(GREEN)ðŸš€ Iniciando frontend (API en red)...$(NC)"
	@echo "$(YELLOW)   Puerto: $(PORT_LOCAL)$(NC)"
	@echo "$(YELLOW)   API: $(API_NETWORK)$(NC)"
	@echo ""
	REACT_APP_API_URL=$(API_NETWORK)/api $(NPM) start

## Alias para dev
start: dev

## Iniciar con hot-reload mÃ¡s agresivo
dev-fast:
	@echo "$(GREEN)ðŸš€ Iniciando frontend (modo rÃ¡pido)...$(NC)"
	FAST_REFRESH=true $(NPM) start

# ============================================================
# COMPILACIÃ“N
# ============================================================

## Compilar para producciÃ³n
build:
	@echo "$(GREEN)ðŸ”¨ Compilando para producciÃ³n...$(NC)"
	$(NPM) run build
	@echo "$(GREEN)âœ… Build completado en: build/$(NC)"
	@du -sh build/ 2>/dev/null || true

## Compilar y analizar bundle
build-analyze:
	@echo "$(GREEN)ðŸ” Compilando y analizando bundle...$(NC)"
	$(NPM) run build -- --stats
	@echo "$(YELLOW)Usa 'npx webpack-bundle-analyzer build/bundle-stats.json' para ver el anÃ¡lisis$(NC)"

## Servir build de producciÃ³n localmente
serve:
	@echo "$(GREEN)ðŸŒ Sirviendo build de producciÃ³n...$(NC)"
	@npx serve -s build -l $(PORT_LOCAL) 2>/dev/null || \
		(echo "$(YELLOW)Instalando serve...$(NC)" && npm install -g serve && npx serve -s build -l $(PORT_LOCAL))

# ============================================================
# DEPENDENCIAS
# ============================================================

## Instalar dependencias
install:
	@echo "$(GREEN)ðŸ“¦ Instalando dependencias...$(NC)"
	$(NPM) install

## Instalar dependencias (limpio)
install-clean:
	@echo "$(GREEN)ðŸ“¦ InstalaciÃ³n limpia...$(NC)"
	rm -rf node_modules package-lock.json
	$(NPM) install

## Actualizar dependencias
update:
	@echo "$(GREEN)â¬†ï¸  Actualizando dependencias...$(NC)"
	$(NPM) update

## Ver dependencias desactualizadas
outdated:
	@echo "$(GREEN)ðŸ“‹ Dependencias desactualizadas:$(NC)"
	$(NPM) outdated || true

## Mostrar dependencias instaladas
deps:
	@echo "$(GREEN)ðŸ“¦ Dependencias del proyecto:$(NC)"
	$(NPM) list --depth=0

## Auditar seguridad
audit:
	@echo "$(GREEN)ðŸ”’ AuditorÃ­a de seguridad:$(NC)"
	$(NPM) audit || true

## Corregir vulnerabilidades
audit-fix:
	@echo "$(GREEN)ðŸ”§ Corrigiendo vulnerabilidades...$(NC)"
	$(NPM) audit fix || true

# ============================================================
# CALIDAD DE CÃ“DIGO
# ============================================================

## Ejecutar linter
lint:
	@echo "$(GREEN)ðŸ” Ejecutando linter...$(NC)"
	$(NPM) run lint 2>/dev/null || npx eslint src/ --ext .js,.jsx

## Corregir errores de linting
lint-fix:
	@echo "$(GREEN)ðŸ”§ Corrigiendo errores de linting...$(NC)"
	$(NPM) run lint:fix 2>/dev/null || npx eslint src/ --ext .js,.jsx --fix

## Formatear cÃ³digo con Prettier
format:
	@echo "$(GREEN)âœ¨ Formateando cÃ³digo...$(NC)"
	npx prettier --write "src/**/*.{js,jsx,css,json}" 2>/dev/null || \
		echo "$(YELLOW)Prettier no instalado. Ejecuta: npm install -D prettier$(NC)"

# ============================================================
# TESTS
# ============================================================

## Ejecutar tests
test:
	@echo "$(GREEN)ðŸ§ª Ejecutando tests...$(NC)"
	$(NPM) test -- --watchAll=false

## Ejecutar tests en modo watch
test-watch:
	@echo "$(GREEN)ðŸ§ª Tests en modo watch...$(NC)"
	$(NPM) test

## Ejecutar tests con cobertura
test-coverage:
	@echo "$(GREEN)ðŸ§ª Tests con cobertura...$(NC)"
	$(NPM) test -- --coverage --watchAll=false

# ============================================================
# LIMPIEZA
# ============================================================

## Limpiar node_modules y build
clean:
	@echo "$(YELLOW)ðŸ§¹ Limpiando proyecto...$(NC)"
	rm -rf node_modules build .cache
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

## Limpiar solo build
clean-build:
	@echo "$(YELLOW)ðŸ§¹ Limpiando build...$(NC)"
	rm -rf build
	@echo "$(GREEN)âœ… Build eliminado$(NC)"

## Limpiar cache
clean-cache:
	@echo "$(YELLOW)ðŸ§¹ Limpiando cache...$(NC)"
	rm -rf .cache node_modules/.cache
	$(NPM) cache clean --force
	@echo "$(GREEN)âœ… Cache limpiado$(NC)"

# ============================================================
# UTILIDADES
# ============================================================

## Abrir en navegador
open:
	@echo "$(GREEN)ðŸŒ Abriendo en navegador...$(NC)"
	@open http://localhost:$(PORT_LOCAL) 2>/dev/null || \
		xdg-open http://localhost:$(PORT_LOCAL) 2>/dev/null || \
		echo "$(YELLOW)Abre manualmente: http://localhost:$(PORT_LOCAL)$(NC)"

## Mostrar puertos en uso
ports:
	@echo "$(GREEN)ðŸ”Œ Puertos en uso:$(NC)"
	@lsof -i :$(PORT_LOCAL) 2>/dev/null || echo "$(YELLOW)Puerto $(PORT_LOCAL) libre$(NC)"

## Matar proceso en puerto 3000
kill:
	@echo "$(YELLOW)ðŸ”ª Matando proceso en puerto $(PORT_LOCAL)...$(NC)"
	@lsof -ti :$(PORT_LOCAL) | xargs kill -9 2>/dev/null && echo "$(GREEN)âœ… Proceso terminado$(NC)" || \
		echo "$(YELLOW)No hay proceso en puerto $(PORT_LOCAL)$(NC)"

## Ver tamaÃ±o de node_modules
size:
	@echo "$(GREEN)ðŸ“Š TamaÃ±o de directorios:$(NC)"
	@du -sh node_modules 2>/dev/null || echo "node_modules: no existe"
	@du -sh build 2>/dev/null || echo "build: no existe"

## Generar Ã¡rbol de componentes
tree:
	@echo "$(GREEN)ðŸŒ³ Estructura de componentes:$(NC)"
	@find src/components -name "*.jsx" -o -name "*.js" | head -30

# ============================================================
# INFORMACIÃ“N
# ============================================================

## Mostrar informaciÃ³n del proyecto
info:
	@echo ""
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(GREEN)  CENATE Frontend - InformaciÃ³n$(NC)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "  $(YELLOW)Puerto:$(NC)        $(PORT_LOCAL)"
	@echo "  $(YELLOW)API Local:$(NC)     $(API_LOCAL)"
	@echo "  $(YELLOW)API Network:$(NC)   $(API_NETWORK)"
	@echo "  $(YELLOW)Node:$(NC)          $$(node -v 2>/dev/null || echo 'No instalado')"
	@echo "  $(YELLOW)NPM:$(NC)           $$(npm -v 2>/dev/null || echo 'No instalado')"
	@echo ""
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""

## Verificar versiones
versions:
	@echo "$(GREEN)ðŸ“‹ Versiones:$(NC)"
	@echo "  Node: $$(node -v 2>/dev/null || echo 'No instalado')"
	@echo "  NPM:  $$(npm -v 2>/dev/null || echo 'No instalado')"
	@echo "  React: $$(cat package.json | grep '\"react\":' | head -1 | awk -F'\"' '{print $$4}')"

# Default target
.DEFAULT_GOAL := help
