#!/bin/bash

# üöÄ Script de Instalaci√≥n Autom√°tica del Sistema RBAC
# Autor: Claude AI
# Descripci√≥n: Configura autom√°ticamente el sistema RBAC en tu proyecto

set -e

echo "üîê =========================================="
echo "   INSTALACI√ìN SISTEMA RBAC - CENATE"
echo "==========================================="
echo ""

# Colores
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Directorio base
BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SRC_DIR="$BASE_DIR/src"

echo -e "${BLUE}üìÇ Directorio del proyecto:${NC} $BASE_DIR"
echo ""

# Verificar que estamos en el directorio correcto
if [ ! -f "$BASE_DIR/package.json" ]; then
    echo -e "${RED}‚ùå Error: package.json no encontrado${NC}"
    echo "   Por favor ejecuta este script desde el directorio frontend/"
    exit 1
fi

echo -e "${GREEN}‚úÖ Proyecto React encontrado${NC}"
echo ""

# 1. Verificar estructura de carpetas
echo -e "${BLUE}üìÅ Verificando estructura de carpetas...${NC}"

REQUIRED_DIRS=(
    "$SRC_DIR/hooks"
    "$SRC_DIR/components/ProtectedRoute"
    "$SRC_DIR/utils"
)

for dir in "${REQUIRED_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        echo -e "${GREEN}‚úÖ${NC} $dir"
    else
        echo -e "${YELLOW}üìÅ Creando${NC} $dir"
        mkdir -p "$dir"
    fi
done

echo ""

# 2. Verificar archivos creados
echo -e "${BLUE}üìÑ Verificando archivos del sistema RBAC...${NC}"

check_file() {
    if [ -f "$1" ]; then
        echo -e "${GREEN}‚úÖ${NC} $1"
        return 0
    else
        echo -e "${RED}‚ùå${NC} $1 ${YELLOW}(faltante)${NC}"
        return 1
    fi
}

REQUIRED_FILES=(
    "$SRC_DIR/hooks/usePermissions.js"
    "$SRC_DIR/components/ProtectedRoute/ProtectedRoute.js"
    "$SRC_DIR/components/DynamicSidebar.js"
    "$SRC_DIR/components/AppLayout.js"
)

MISSING_FILES=0
for file in "${REQUIRED_FILES[@]}"; do
    if ! check_file "$file"; then
        ((MISSING_FILES++))
    fi
done

echo ""

if [ $MISSING_FILES -gt 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Advertencia: ${MISSING_FILES} archivo(s) faltante(s)${NC}"
    echo -e "${YELLOW}   Por favor copia los archivos desde los artifacts de Claude${NC}"
    echo ""
fi

# 3. Verificar dependencias
echo -e "${BLUE}üì¶ Verificando dependencias npm...${NC}"

REQUIRED_PACKAGES=(
    "react-router-dom"
    "react-hot-toast"
    "lucide-react"
)

for pkg in "${REQUIRED_PACKAGES[@]}"; do
    if grep -q "\"$pkg\"" "$BASE_DIR/package.json"; then
        echo -e "${GREEN}‚úÖ${NC} $pkg"
    else
        echo -e "${RED}‚ùå${NC} $pkg ${YELLOW}(no instalado)${NC}"
    fi
done

echo ""

# 4. Crear archivo de utilidades si no existe
UTILS_FILE="$SRC_DIR/utils/rbacUtils.js"
if [ ! -f "$UTILS_FILE" ]; then
    echo -e "${YELLOW}üìù Creando archivo de utilidades...${NC}"
    cat > "$UTILS_FILE" << 'EOF'
/**
 * Utilidades RBAC - Generado autom√°ticamente
 * Por favor reemplaza con el contenido del artifact 'utils_rbac'
 */

export const ACCIONES = {
  VER: 'ver',
  CREAR: 'crear',
  EDITAR: 'editar',
  ELIMINAR: 'eliminar',
  EXPORTAR: 'exportar',
  APROBAR: 'aprobar'
};

export const MODULOS = {
  CITAS: 'Gesti√≥n de Citas',
  COORDINADORES: 'Gesti√≥n de Coordinadores',
  EXTERNO: 'Gesti√≥n de Personal Externo',
  LINEAMIENTOS: 'Lineamientos IPRESS',
  MEDICO: 'Panel M√©dico'
};

export default { ACCIONES, MODULOS };
EOF
    echo -e "${GREEN}‚úÖ Archivo de utilidades creado${NC}"
else
    echo -e "${GREEN}‚úÖ Archivo de utilidades ya existe${NC}"
fi

echo ""

# 5. Crear p√°ginas de ejemplo si no existen
echo -e "${BLUE}üìÑ Verificando p√°ginas...${NC}"

PAGES_DIR="$SRC_DIR/pages"
mkdir -p "$PAGES_DIR"

EXAMPLE_PAGES=(
    "CitasMedico.js"
    "PacientesMedico.js"
    "IndicadoresMedico.js"
    "DashboardCitas.js"
    "AgendaMedica.js"
    "DashboardCoordinador.js"
    "AgendaCoordinador.js"
    "DashboardExterno.js"
    "ReportesExterno.js"
    "DashboardLineamientos.js"
    "RegistroLineamientos.js"
)

PAGES_CREATED=0
for page in "${EXAMPLE_PAGES[@]}"; do
    PAGE_FILE="$PAGES_DIR/$page"
    if [ ! -f "$PAGE_FILE" ]; then
        echo -e "${YELLOW}üìù Creando${NC} $page"
        PAGE_NAME="${page%.js}"
        
        cat > "$PAGE_FILE" << EOF
import React from 'react';
import AppLayout, { ActionToolbar } from '../components/AppLayout';
import { ProtectedRoute } from '../components/ProtectedRoute/ProtectedRoute';

// TODO: Actualizar esta ruta seg√∫n tu backend
const CURRENT_PATH = '/roles/pendiente/$PAGE_NAME';

const $PAGE_NAME = () => {
  return (
    <AppLayout currentPath={CURRENT_PATH} title="$PAGE_NAME">
      <ActionToolbar
        currentPath={CURRENT_PATH}
        onCrear={() => console.log('Crear')}
        onExportar={() => console.log('Exportar')}
      />

      <div className="bg-white rounded-2xl shadow-sm p-6">
        <h2 className="text-xl font-bold mb-4">$PAGE_NAME</h2>
        <p className="text-slate-600">
          Esta es una p√°gina de ejemplo. Por favor implementa tu l√≥gica aqu√≠.
        </p>
        <div className="mt-4 bg-yellow-50 border border-yellow-200 rounded-xl p-4">
          <p className="text-yellow-800 text-sm">
            ‚ö†Ô∏è <strong>TODO:</strong> Actualiza CURRENT_PATH con la ruta correcta de tu API
          </p>
        </div>
      </div>
    </AppLayout>
  );
};

export default () => (
  <ProtectedRoute requiredPath={CURRENT_PATH} requiredAction="ver">
    <$PAGE_NAME />
  </ProtectedRoute>
);
EOF
        ((PAGES_CREATED++))
    else
        echo -e "${GREEN}‚úÖ${NC} $page"
    fi
done

if [ $PAGES_CREATED -gt 0 ]; then
    echo -e "${GREEN}‚úÖ Creadas $PAGES_CREATED p√°ginas de ejemplo${NC}"
fi

echo ""

# 6. Crear script de test
TEST_SCRIPT="$BASE_DIR/test_rbac_api.sh"
echo -e "${BLUE}üß™ Creando script de test...${NC}"

cat > "$TEST_SCRIPT" << 'EOF'
#!/bin/bash

# Script de test para API RBAC
# Aseg√∫rate de tener un token v√°lido

BASE_URL="${BASE_URL:-http://localhost:8080}"
JWT_TOKEN="${JWT_TOKEN:-}"

if [ -z "$JWT_TOKEN" ]; then
    echo "‚ùå Error: Define la variable JWT_TOKEN"
    echo "   Ejemplo: export JWT_TOKEN='tu_token_aqui'"
    exit 1
fi

echo "üß™ Testing RBAC API..."
echo "Base URL: $BASE_URL"
echo ""

# Health Check
echo "1Ô∏è‚É£ Health Check"
curl -s -X GET "$BASE_URL/api/permisos/health" \
  -H "Authorization: Bearer $JWT_TOKEN" | jq .

echo ""
echo "2Ô∏è‚É£ Permisos de Usuario 1"
curl -s -X GET "$BASE_URL/api/permisos/usuario/1" \
  -H "Authorization: Bearer $JWT_TOKEN" | jq '. | length'

echo ""
echo "3Ô∏è‚É£ M√≥dulos de Usuario 1"
curl -s -X GET "$BASE_URL/api/permisos/usuario/1/modulos" \
  -H "Authorization: Bearer $JWT_TOKEN" | jq .

echo ""
echo "‚úÖ Tests completados"
EOF

chmod +x "$TEST_SCRIPT"
echo -e "${GREEN}‚úÖ Script de test creado: test_rbac_api.sh${NC}"

echo ""

# 7. Resumen final
echo -e "${BLUE}=========================================="
echo "   RESUMEN DE INSTALACI√ìN"
echo "==========================================${NC}"
echo ""

if [ $MISSING_FILES -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Todos los archivos principales est√°n presentes${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  ${MISSING_FILES} archivo(s) principal(es) faltante(s)${NC}"
fi

if [ $PAGES_CREATED -gt 0 ]; then
    echo -e "${GREEN}‚úÖ ${PAGES_CREATED} p√°gina(s) de ejemplo creadas${NC}"
fi

echo -e "${GREEN}‚úÖ Script de test creado${NC}"
echo ""

# 8. Pr√≥ximos pasos
echo -e "${BLUE}üìã PR√ìXIMOS PASOS:${NC}"
echo ""
echo "1. Verifica que todos los archivos est√©n presentes:"
echo -e "   ${YELLOW}npm start${NC}"
echo ""
echo "2. Si hay archivos faltantes, c√≥pialos desde los artifacts de Claude:"
echo "   - usePermissions.js"
echo "   - ProtectedRoute.js"
echo "   - DynamicSidebar.js"
echo "   - AppLayout.js"
echo ""
echo "3. Actualiza App.js con las nuevas rutas"
echo ""
echo "4. Prueba el sistema:"
echo -e "   ${YELLOW}export JWT_TOKEN='tu_token'${NC}"
echo -e "   ${YELLOW}./test_rbac_api.sh${NC}"
echo ""
echo -e "${GREEN}üéâ Instalaci√≥n completada!${NC}"
echo ""
echo "Documentaci√≥n completa en: IMPLEMENTACION_RBAC_COMPLETA.md"
echo ""
