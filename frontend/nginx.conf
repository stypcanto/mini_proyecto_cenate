# ========================================================================
# üåê NGINX CONFIG ‚Äì FRONTEND CENATE 2025
# ------------------------------------------------------------------------
# ‚úÖ React Router (SPA)
# ‚úÖ Im√°genes servidas con alias
# ‚úÖ Proxy al backend Spring Boot
# ‚úÖ Compatible con Apple Silicon / Linux AMD64
# ========================================================================

server {
  listen 80;
  server_name localhost;

  # Carpeta ra√≠z del build de React
  root /usr/share/nginx/html;
  index index.html;

  # =====================================================================
  # üñºÔ∏è SERVIR IM√ÅGENES CORRECTAMENTE
  # ---------------------------------------------------------------------
  # Alias evita el error 404 por duplicar /images/images/
  # y asegura acceso directo a las im√°genes copiadas en el contenedor.
  # =====================================================================
  location ^~ /images/ {
    alias /usr/share/nginx/html/images/;
    autoindex off;
    expires 30d;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
  }

  # =====================================================================
  # ‚öõÔ∏è REACT ROUTER (Single Page Application)
  # ---------------------------------------------------------------------
  # Redirige cualquier ruta no est√°tica hacia index.html
  # =====================================================================
  location / {
    try_files $uri /index.html;
  }

  # =====================================================================
  # üîó PROXY HACIA BACKEND SPRING BOOT
  # ---------------------------------------------------------------------
  # Env√≠a todas las peticiones /api/ al contenedor "backend"
  # =====================================================================
  location /api/ {
    proxy_pass http://backend:8080;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Permitir uploads grandes (ECGs, im√°genes m√©dicas)
    client_max_body_size 10M;
    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }

  # =====================================================================
  # ü™µ LOGS
  # =====================================================================
  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log;
}