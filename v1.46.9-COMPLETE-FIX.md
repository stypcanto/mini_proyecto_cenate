# v1.46.9 - COMPLETE FIX: Doctor Assignment + IPRESS + Fecha ğŸ”§âœ…

**Date:** 2026-02-06
**Commit:** 5afb013
**Status:** âœ… READY FOR TESTING
**Backend:** âœ… Running
**Frontend:** âœ… Built

---

## ğŸ¯ The ROOT PROBLEM (What You Saw)

Patient table showing **"-"** for IPRESS and Fecha AsignaciÃ³n because:

1. **v1.46.5 Problem:** Imported patients had no IPRESS code stored
2. **v1.46.8 Fix:** Added IPRESS code lookup
3. **v1.46.9 ROOT CAUSE:** Imported patients weren't assigned to doctors!

### Why Doctors Couldn't See Patients

**Backend Flow in `obtenerPacientesMedico()`:**
```java
// LÃ­nea 269 de GestionPacienteServiceImpl
List<SolicitudBolsa> solicitudesBolsa =
  solicitudBolsaRepository.findByIdPersonalAndActivoTrue(idPers);
  //                                           â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘
  //                                   Busca medicosAsignados
```

**El problema:**
- Pacientes importados â†’ SolicitudBolsa creada
- Pero `idPersonal` = **NULL** (no asignados a mÃ©dico)
- Query busca `idPersonal = doctor_id` â†’ NO encuentra nada
- Fallback a SolicitudCita â†’ GestionPaciente â†’ sin fechaAsignacion
- Tabla muestra datos incompletos

**v1.46.9 Fix:**
- User selecciona mÃ©dico en modal
- Frontend envÃ­a: `idPersonal`
- Backend guarda: `SolicitudBolsa.idPersonal = doctor_id`
- MÃ©dico busca sus pacientes â†’ Â¡ENCUENTRA TODOS! âœ…
- Con IPRESS y fechaAsignacion completos âœ…

---

## ğŸ“ CAMBIOS DETALLADOS

### Backend Changes

**1. CrearSolicitudAdicionalRequest.java (DTO)**
```java
// âœ… v1.46.9 - Campos para asignar mÃ©dico en importaciÃ³n
private Long idPersonal;              // ID del mÃ©dico a asignar
private OffsetDateTime fechaAsignacion; // Fecha de asignaciÃ³n
```

**2. SolicitudBolsaServiceImpl.java (lÃ­nea 2905-2940)**
```java
// Extraer idPersonal del request
Long idPersonalFinal = request.getIdPersonal() != null
  ? request.getIdPersonal()
  : null;

// Extraer fechaAsignacion del request
OffsetDateTime fechaAsignacionFinal =
  request.getFechaAsignacion() != null
    ? request.getFechaAsignacion()
    : OffsetDateTime.now();

// Al crear SolicitudBolsa:
.idPersonal(idPersonalFinal)           // â† NUEVO
.fechaAsignacion(fechaAsignacionFinal) // â† ACTUALIZADO
```

### Frontend Changes

**GestionAsegurado.jsx (lÃ­nea 839-840)**
```javascript
// Enviar mÃ©dico y fecha al importar
idPersonal: medicoSeleccionado ? parseInt(medicoSeleccionado) : null,
fechaAsignacion: fechaHoraCitaSeleccionada
  ? new Date(fechaHoraCitaSeleccionada).toISOString()
  : null,
```

---

## âœ… QUÃ‰ SE ARREGLÃ“

| Issue | v1.46.5 | v1.46.8 | v1.46.9 |
|-------|---------|---------|---------|
| IPRESS NULL | âŒ NULL | âœ… Lookup | âœ… Lookup |
| Fecha "-" | âŒ "-" | âœ… Formateada | âœ… Formateada |
| Doctor vÃ© pacientes | âŒ NO | âŒ NO | âœ… SÃ |
| Paciente asignado a mÃ©dico | âŒ NO | âŒ NO | âœ… SÃ |
| `idPersonal` guardado | âŒ NULL | âŒ NULL | âœ… doctor_id |

---

## ğŸ§ª TESTING - PASO A PASO

### Test 1: Importar Paciente con MÃ©dico

**1. Login Coordinador**
```
URL: http://localhost:3000/login
Email: stypcanto@essalud.gob.pe (o tu usuario)
Password: Cenate@2024
```

**2. Ir a GestiÃ³n de Asegurados**
```
URL: http://localhost:3000/roles/citas/gestion-asegurado
```

**3. Buscar paciente**
```
DNI: 34567803 (o cualquier otro paciente real)
Buscar
```

**4. Importar con campos COMPLETOS**
```
âœ… Especialidad:    CARDIOLOGIA
âœ… MÃ©dico:          Dr. Nombre MÃ©dico (seleccionar dropdown)
âœ… Fecha/Hora:      06/02/2026 10:30 AM (usar datetime picker)
Click: "Importar"
```

**5. Verificar respuesta**
```
âœ… Toast: "Paciente importado a CARDIOLOGIA"
âœ… En BD: SolicitudBolsa.idPersonal = doctor_id
âœ… En BD: SolicitudBolsa.fechaAsignacion = timestamp
```

### Test 2: Ver en "Mis Pacientes" como MÃ©dico

**1. Logout y Login como MÃ©dico**
```
Email: (mÃ©dico que seleccionÃ³ en step 4)
Password: Cenate@2024
```

**2. Ir a Mis Pacientes**
```
URL: http://localhost:3000/roles/medico/pacientes
Click: "Actualizar"
```

**3. Verificar tabla - DEBE MOSTRAR:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DNI         â”‚ Paciente         â”‚ IPRESS   â”‚ CondiciÃ³n        â”‚ Fecha AsignaciÃ³n         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 34567803    â”‚ Juan PÃ©rez       â”‚ CAP II   â”‚ Pendiente        â”‚ 06/02/2026, 10:30 a.m.  â”‚
â”‚             â”‚ Asegurado        â”‚ LURIN âœ… â”‚ (clickeable)      â”‚ (formateada) âœ…          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**4. Verificar IPRESS y Fecha:**
```
IPRESS:
- âœ… NO debe ser null
- âœ… NO debe ser "-"
- âœ… Debe ser "CAP II LURIN" o nombre de IPRESS

Fecha AsignaciÃ³n:
- âœ… NO debe ser "-"
- âœ… Debe ser "06/02/2026, 10:30 a.m." (formateado)
- âœ… Mismo que seleccionÃ³ en importaciÃ³n
```

### Test 3: Verificar SincronizaciÃ³n en BD

```sql
-- Conectar a BD: maestro_cenate
-- Host: 10.0.89.241:5432

-- Verificar paciente importado
SELECT
  id_solicitud,
  numero_solicitud,
  paciente_dni,
  paciente_nombre,
  codigo_ipress_adscripcion,  -- Debe tener "450" o similar
  id_personal,                -- Debe tener doctor_id
  fecha_asignacion,           -- Debe tener timestamp
  estado
FROM dim_solicitud_bolsa
WHERE paciente_dni = '34567803'
ORDER BY fecha_creacion DESC
LIMIT 1;

-- Resultado esperado:
-- id_solicitud     | 1234
-- numero_solicitud | IMP-20260206-0001
-- paciente_dni     | 34567803
-- paciente_nombre  | Juan PÃ©rez
-- codigo_ipress... | 450 âœ… (NOT NULL)
-- id_personal      | 45 âœ… (doctor_id, NOT NULL)
-- fecha_asignacion | 2026-02-06 10:30:00+00:00 âœ… (NOT NULL)
-- estado           | PENDIENTE
```

---

## ğŸ“Š FLUJO COMPLETO v1.46.9

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COORDINADOR: GestionAsegurado (Importar Paciente)          â”‚
â”‚                                                              â”‚
â”‚ 1. Buscar: DNI 34567803                                     â”‚
â”‚ 2. Modal aparece con campos:                                â”‚
â”‚    - Especialidad: CARDIOLOGIA          [dropdown]          â”‚
â”‚    - MÃ©dico: Dr. Juan PÃ©rez             [dropdown] âœ… NUEVO â”‚
â”‚    - Fecha/Hora: 06/02/2026 10:30 AM    [datetime] âœ… NUEVO â”‚
â”‚ 3. Click: "Importar"                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
        POST /api/bolsas/solicitudes/crear-adicional
        Payload:
        {
          pacienteDni: "34567803",
          descIpress: "CAP II LURIN",
          especialidad: "CARDIOLOGIA",
          idPersonal: 45,              â† âœ… NUEVO
          fechaAsignacion: "2026-02-06T10:30:00Z" â† âœ… NUEVO
        }
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: SolicitudBolsaServiceImpl.crearSolicitudAdicional() â”‚
â”‚                                                              â”‚
â”‚ 1. Validar paciente en asegurados âœ…                        â”‚
â”‚ 2. obtenerCodigoIpress("CAP II LURIN")                      â”‚
â”‚    â†’ busca en BD â†’ retorna "450" âœ…                         â”‚
â”‚ 3. Leer idPersonal del request (45) âœ…                      â”‚
â”‚ 4. Leer fechaAsignacion del request âœ…                      â”‚
â”‚ 5. Crear SolicitudBolsa:                                    â”‚
â”‚    {                                                        â”‚
â”‚      idPersonal: 45,           â† âœ… ASIGNADO AL MÃ‰DICO      â”‚
â”‚      codigoIpress: "450",      â† âœ… CÃ“DIGO IPRESS           â”‚
â”‚      fechaAsignacion: "2026-02-06T10:30:00Z", â† âœ…         â”‚
â”‚      idBolsa: 10 (BOLSA_GESTORA),                           â”‚
â”‚      especialidad: "CARDIOLOGIA",                           â”‚
â”‚      estado: "PENDIENTE"                                    â”‚
â”‚    }                                                        â”‚
â”‚ 6. Guardar en dim_solicitud_bolsa âœ…                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
        Toast: "Paciente importado a CARDIOLOGIA" âœ…
                         â†“
        Frontend recarga tabla
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MÃ‰DICO (ID=45): Mis Pacientes                              â”‚
â”‚ GET /api/gestion-pacientes/medico/asignados                â”‚
â”‚                                                              â”‚
â”‚ Backend:                                                    â”‚
â”‚ 1. Get current user â†’ PersonalCnt(idPers=45)               â”‚
â”‚ 2. findByIdPersonalAndActivoTrue(45)  â† âœ… BUSCA idPersonalâ”‚
â”‚ 3. Encuentra SolicitudBolsa (porque idPersonal=45) âœ…      â”‚
â”‚ 4. Convierte a GestionPacienteDTO:                          â”‚
â”‚    {                                                        â”‚
â”‚      numDoc: "34567803",                                    â”‚
â”‚      apellidosNombres: "Juan PÃ©rez",                        â”‚
â”‚      ipress: "CAP II LURIN",       â† âœ… DESDE CÃ“DIGO 450    â”‚
â”‚      fechaAsignacion: "2026-02-06T10:30:00Z", â† âœ…         â”‚
â”‚      condicion: "Pendiente"                                 â”‚
â”‚    }                                                        â”‚
â”‚ 5. Retorna al frontend                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”‚ TABLA: Mis Pacientes (Frontend)                            â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”‚ DNI     â”‚ Paciente     â”‚ IPRESS           â”‚ Fecha Asig.  â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚ 3456780 â”‚ Juan PÃ©rez   â”‚ CAP II LURIN âœ…  â”‚ 06/02/26...  â”‚
â”‚ â”‚         â”‚ Asegurado    â”‚ (no null)        â”‚ 10:30 a.m.âœ… â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                          âœ… Â¡Ã‰XITO!
```

---

## ğŸ› Si Algo No Funciona

### Caso 1: Paciente aÃºn no aparece en Mis Pacientes
```
Causas posibles:
1. El mÃ©dico ingresÃ³ sin seleccionar mÃ©dico en el modal
   â†’ SoluciÃ³n: importar de nuevo Y seleccionar mÃ©dico

2. CachÃ© del navegador
   â†’ SoluciÃ³n: Ctrl+Shift+R (hard refresh) o Clear Cache

3. Backend no reiniciado con nuevo cÃ³digo
   â†’ SoluciÃ³n: Matar proceso y reiniciar ./gradlew bootRun

4. Frontend apunta a vieja build
   â†’ SoluciÃ³n: npm run build y recargar pÃ¡gina
```

### Caso 2: IPRESS aÃºn muestra NULL
```
Causas posibles:
1. IPRESS code no existe en BD
   â†’ Verificar en tabla ipress: SELECT * FROM dim_ipress

2. CÃ³digo IPRESS mal formado
   â†’ Revisar: obtenerCodigoIpress() backend

3. Asegurado sin casAdscripcion en BD
   â†’ Verificar: SELECT * FROM asegurados WHERE doc_paciente='34567803'
```

### Caso 3: Fecha aÃºn muestra "-"
```
Causas posibles:
1. formatearFecha() no detecta formato ISO con Z
   â†’ Revisar: MisPacientes.jsx lÃ­nea 76-108

2. Fecha no se guardÃ³ en BD
   â†’ Verificar: SELECT fecha_asignacion FROM dim_solicitud_bolsa

3. Stale cache de React
   â†’ SoluciÃ³n: Hard refresh del navegador
```

---

## ğŸ” DEBUG LOGS ESPERADOS

### Backend Logs (cuando se importa)
```
ğŸ“ Creando solicitud adicional para DNI: 34567803

âœ… Paciente validado: Juan PÃ©rez - DNI: 34567803

ğŸ” [Auto-Assign] Usuario encontrado: styp_canto â†’ ID: 1

ğŸ” [v1.46.8] IPRESS input: 'CAP II LURIN' â†’ cÃ³digo final: '450'

ğŸ” [v1.46.9] idPersonal enviado: 45  â† âœ… MÃ‰DICO ASIGNADO

âœ… Solicitud adicional creada: 1234 - MÃ©dico ID: 45 - Gestor ID: 1 - IPRESS: 450
```

### Frontend Logs (en Mis Pacientes)
```javascript
// Console:
ğŸ” [DEBUG] Datos del API: Array(1)
ğŸ” [DEBUG] Primer paciente estructura: {
  idGestion: 1,
  numDoc: "34567803",
  apellidosNombres: "Juan PÃ©rez",
  ipress: "CAP II LURIN",  â† âœ… (no null)
  fechaAsignacion: "2026-02-06T10:30:54.000Z", â† âœ… (no null)
  condicion: "Pendiente"
}
ğŸ” [DEBUG] ipress: "CAP II LURIN"
ğŸ” [DEBUG] fechaAsignacion: "2026-02-06T10:30:54.000Z"
```

---

## âœ… CHECKLIST PRE-DEPLOYMENT

- [ ] Backend builds: `./gradlew clean build -x test`
- [ ] Frontend builds: `npm run build`
- [ ] Backend starts: `curl http://localhost:8080/api/health`
- [ ] Import with doctor selection works
- [ ] Doctor can see patients in "Mis Pacientes"
- [ ] IPRESS shows correctly (not null)
- [ ] Fecha AsignaciÃ³n shows correctly (not "-")
- [ ] Click "Actualizar" reloads data
- [ ] Patient data persists across page reloads

---

## ğŸ“ COMMITS

| Hash | Mensaje | Version |
|------|---------|---------|
| a635c7a | fix(v1.46.8): IPRESS NULL + Fecha formatting | v1.46.8 |
| a3e4eec | docs(v1.46.8): DocumentaciÃ³n de fixes | v1.46.8 |
| d518a3c | docs(v1.46.8): ComparaciÃ³n antes/despuÃ©s visual | v1.46.8 |
| 5afb013 | fix(v1.46.9): Doctor assignment + complete fix | v1.46.9 |

---

**Status:** âœ… READY FOR USER TESTING
**Backend:** âœ… Running on port 8080
**Frontend:** âœ… Build ready
**Database:** âœ… Migrations applied

**Next:** User tests imports with doctor selection and verifies Mis Pacientes table!
